<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>🔍 Diagnóstico Completo - Papiro Digital</title>
    <style>
        body {
            background: #0f0f0f;
            color: white;
            font-family: 'Courier New', monospace;
            padding: 1rem;
            font-size: 14px;
            line-height: 1.4;
        }
        .status { background: #88c999; color: black; padding: 0.5rem; margin: 0.5rem 0; border-radius: 4px; }
        .error { background: #ef4444; color: white; padding: 0.5rem; margin: 0.5rem 0; border-radius: 4px; }
        .info { background: #3b82f6; color: white; padding: 0.5rem; margin: 0.5rem 0; border-radius: 4px; }
        .warning { background: #f59e0b; color: black; padding: 0.5rem; margin: 0.5rem 0; border-radius: 4px; }
        .log { background: #1f2937; padding: 1rem; border-radius: 4px; margin: 1rem 0; overflow-x: auto; max-height: 200px; overflow-y: auto; }
        .button { background: #6366f1; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px; margin: 0.5rem; cursor: pointer; text-decoration: none; display: inline-block; }
    </style>
</head>
<body>
    <h1>🔍 Diagnóstico Completo del Sistema</h1>
    
    <div id="results"></div>
    
    <div class="log">
        <h3>📋 Log de diagnóstico:</h3>
        <div id="log"></div>
    </div>
    
    <div>
        <a href="index.html" class="button">🏠 Ir al login</a>
        <a href="mi_tablero.html" class="button">📊 Ir al dashboard</a>
        <a href="espacio.html?id=test&pdfId=test" class="button">📄 Ir al visor PDF</a>
        <button onclick="location.reload(true)" class="button">🔄 Recargar</button>
    </div>

    <script>
        const results = document.getElementById('results');
        const logDiv = document.getElementById('log');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            
            const logEntry = document.createElement('div');
            logEntry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logDiv.appendChild(logEntry);
            
            console.log(message);
        }
        
        // Test 1: Información básica
        log(`🌍 Dominio: ${window.location.hostname}`, 'info');
        log(`🔗 URL completa: ${window.location.href}`, 'info');
        log(`⏰ Timestamp: ${new Date().toISOString()}`, 'info');
        log(`🖥️ User Agent: ${navigator.userAgent}`, 'info');
        
        // Test 2: Verificar caché
        const cacheTest = performance.navigation?.type;
        if (cacheTest === 1) {
            log('🔄 Página recargada (puede tener caché)', 'warning');
        } else if (cacheTest === 0) {
            log('✅ Carga normal de página', 'status');
        }
        
        // Test 3: Verificar scripts básicos
        setTimeout(() => {
            // PDF.js
            if (typeof pdfjsLib !== 'undefined') {
                log('✅ PDF.js cargado correctamente', 'status');
                log(`📚 Versión PDF.js: ${pdfjsLib.version || 'desconocida'}`, 'info');
            } else {
                log('❌ PDF.js NO cargado', 'error');
            }
            
            // Sistema de emergencia
            if (typeof window.emergencyPDFLoader !== 'undefined') {
                log('✅ Sistema de emergencia PDF cargado', 'status');
            } else {
                log('❌ Sistema de emergencia PDF NO cargado', 'error');
            }
            
            // SweetAlert2
            if (typeof Swal !== 'undefined') {
                log('✅ SweetAlert2 cargado correctamente', 'status');
            } else {
                log('❌ SweetAlert2 NO cargado', 'error');
            }
        }, 2000);
        
        // Test 4: Verificar Firebase
        setTimeout(() => {
            if (typeof firebase !== 'undefined' || window.auth) {
                log('✅ Firebase parece estar disponible', 'status');
            } else {
                log('❌ Firebase NO detectado', 'error');
            }
        }, 3000);
        
        // Test 5: Test de conectividad a Firebase
        setTimeout(async () => {
            try {
                log('🔥 Intentando conectar a Firebase...', 'info');
                
                // Verificar si el módulo Firebase está disponible
                const response = await fetch('./firebase-config.js');
                if (response.ok) {
                    log('✅ Archivo firebase-config.js accesible', 'status');
                } else {
                    log('❌ No se puede acceder a firebase-config.js', 'error');
                }
            } catch (error) {
                log(`❌ Error de conectividad: ${error.message}`, 'error');
            }
        }, 4000);
        
        // Test 6: Verificar archivos críticos
        const criticalFiles = [
            './emergency-pdf-fix.js',
            './force-emergency-load.js',
            './cache-buster.js',
            'index.html',
            'mi_tablero.html'
        ];
        
        setTimeout(async () => {
            log('🔍 Verificando archivos críticos...', 'info');
            
            for (const file of criticalFiles) {
                try {
                    const response = await fetch(file, { method: 'HEAD' });
                    if (response.ok) {
                        log(`✅ ${file} - Disponible`, 'status');
                    } else {
                        log(`❌ ${file} - Error ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ ${file} - No accesible: ${error.message}`, 'error');
                }
                
                // Pequeña pausa para no saturar
                await new Promise(resolve => setTimeout(resolve, 200));
            }
        }, 5000);
        
        // Test 7: Verificar errores en consola
        window.addEventListener('error', (e) => {
            log(`❌ Error JavaScript: ${e.message} en ${e.filename}:${e.lineno}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            log(`❌ Promise rechazada: ${e.reason}`, 'error');
        });
        
        log('🚀 Diagnóstico iniciado...', 'status');
    </script>
    
    <!-- Intentar cargar scripts para ver si funcionan -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="./emergency-pdf-fix.js?v=2.0&t=1729283400"></script>
    <script src="./force-emergency-load.js?v=2.0&t=1729283400"></script>
    <script src="./cache-buster.js?v=2.0&t=1729283400"></script>
</body>
</html>