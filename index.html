<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bienvenido a Papiro Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f0f0f; }
        .form-container { display: none; background-color: #181818; border: 1px solid #2a2a2a; }
        .password-container { position: relative; }
        .toggle-password { position: absolute; top: 50%; right: 1rem; transform: translateY(-50%); cursor: pointer; color: #9ca3af; }
    </style>
</head>
<body class="text-white">
    <div id="loader" class="min-h-screen flex items-center justify-center p-4">
        <p>Verificando sesión...</p>
    </div>
    <div id="login-container" class="form-container min-h-screen items-center justify-center p-4">
        <div class="w-full max-w-md p-8 rounded-xl shadow-lg">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white">Iniciar Sesión</h1>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="text-sm font-medium text-gray-400">Email</label>
                    <input id="login-email" type="email" required class="w-full mt-2 bg-[#2a2a2a] text-white p-3 rounded-lg border border-transparent focus:outline-none focus:ring-2 focus:ring-[#88c999]">
                </div>
                <div class="password-container">
                    <label for="login-password" class="text-sm font-medium text-gray-400">Contraseña</label>
                    <input id="login-password" type="password" required class="w-full mt-2 bg-[#2a2a2a] text-white p-3 rounded-lg border border-transparent focus:outline-none focus:ring-2 focus:ring-[#88c999]">
                    <span id="login-toggle" class="toggle-password"><i id="login-eye-open" class="fas fa-eye"></i><i id="login-eye-closed" class="fas fa-eye-slash hidden"></i></span>
                </div>
                 <div id="login-error-message" class="text-red-400 text-sm h-4"></div>
                <button type="submit" class="w-full mt-2 bg-[#88c999] text-[#1C1C1C] font-bold py-3 rounded-lg hover:brightness-110 transition">Ingresar</button>
            </form>
             <div class="mt-4 flex items-center justify-center">
                 <hr class="w-full border-gray-600"><span class="px-2 text-gray-500">o</span><hr class="w-full border-gray-600">
             </div>
            <div class="mt-4">
                <button id="google-login-btn" class="w-full bg-white text-black font-semibold py-3 rounded-lg hover:bg-gray-200 transition flex items-center justify-center">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" class="h-6 w-6 mr-3" alt="Google icon">
                    Continuar con Google
                </button>
            </div>
        </div>
    </div>
    <script type="module">
        import { auth, FirebaseUtils, checkFirebaseConnection } from './firebase-config.js';
        import { onAuthStateChanged, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { APP_CONFIG, logger } from './config.js';
        
        const loader = document.getElementById('loader');
        const loginContainer = document.getElementById('login-container');
        const loginForm = document.getElementById('login-form');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const loginErrorMessage = document.getElementById('login-error-message');
        
        // Variables de estado
        let isAuthStateListening = false;
        let authStateTimeout = null;
        
        // Inicializar la aplicación
        async function initializeApp() {
            try {
                logger.info('Inicializando Papiro Digital...');
                
                // Verificar conexión a Firebase
                const connectionStatus = await checkFirebaseConnection();
                if (!connectionStatus.connected) {
                    throw new Error(connectionStatus.message);
                }
                
                // Configurar timeout para el loader
                authStateTimeout = setTimeout(() => {
                    if (!isAuthStateListening) {
                        loader.querySelector('p').textContent = 'Error de conexión. Reintentando...';
                        setTimeout(() => window.location.reload(), 2000);
                    }
                }, APP_CONFIG.UI.LOADER_TIMEOUT);
                
                // Escuchar cambios de autenticación
                setupAuthStateListener();
                
            } catch (error) {
                logger.error('Error al inicializar la aplicación:', error);
                showError('Error de inicialización: ' + error.message);
            }
        }
        
        // Configurar listener de estado de autenticación
        function setupAuthStateListener() {
            onAuthStateChanged(auth, (user) => {
                isAuthStateListening = true;
                clearTimeout(authStateTimeout);
                
                logger.debug('Estado de auth cambió:', user ? 'Usuario logueado' : 'Usuario no logueado');
                
                if (user) {
                    logger.info('Usuario autenticado, redirigiendo al dashboard...');
                    // Pequeño delay para mejor UX
                    setTimeout(() => {
                        window.location.href = APP_CONFIG.PAGES.DASHBOARD;
                    }, 500);
                } else {
                    showLoginForm();
                }
            }, (error) => {
                logger.error('Error en auth state listener:', error);
                showError(FirebaseUtils.handleAuthError(error));
            });
        }
        
        // Mostrar formulario de login
        function showLoginForm() {
            loader.style.display = 'none';
            loginContainer.style.display = 'flex';
            
            // Focus en el primer input
            setTimeout(() => {
                const emailInput = document.getElementById('login-email');
                if (emailInput) emailInput.focus();
            }, 100);
        }
        
        // Mostrar mensaje de error
        function showError(message) {
            loader.style.display = 'none';
            loginContainer.style.display = 'flex';
            loginErrorMessage.textContent = message;
            loginErrorMessage.className = 'text-red-400 text-sm h-auto p-2 bg-red-900/20 border border-red-500/30 rounded-md';
        }
        
        // Manejar envío del formulario de login
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = loginForm['login-email'].value.trim();
            const password = loginForm['login-password'].value;
            
            // Validaciones básicas
            if (!email || !password) {
                loginErrorMessage.textContent = 'Por favor completa todos los campos';
                return;
            }
            
            if (!APP_CONFIG.UTILS.validateEmail(email)) {
                loginErrorMessage.textContent = 'Por favor ingresa un email válido';
                return;
            }
            
            // Deshabilitar botón y mostrar loading
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Iniciando sesión...';
            loginErrorMessage.textContent = '';
            
            try {
                logger.info('Intentando login con email:', email);
                await signInWithEmailAndPassword(auth, email, password);
                logger.info('Login exitoso');
            } catch (error) {
                logger.error('Error en login:', error);
                loginErrorMessage.textContent = FirebaseUtils.handleAuthError(error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        
        // Manejar login con Google
        async function handleGoogleLogin() {
            loginErrorMessage.textContent = '';
            
            const originalText = googleLoginBtn.textContent;
            googleLoginBtn.disabled = true;
            googleLoginBtn.textContent = 'Conectando con Google...';
            
            try {
                logger.info('Intentando login con Google');
                const provider = new GoogleAuthProvider();
                provider.addScope('email');
                provider.addScope('profile');
                
                await signInWithPopup(auth, provider);
                logger.info('Login con Google exitoso');
            } catch (error) {
                logger.error('Error en login con Google:', error);
                loginErrorMessage.textContent = FirebaseUtils.handleAuthError(error);
            } finally {
                googleLoginBtn.disabled = false;
                googleLoginBtn.textContent = originalText;
            }
        }
        
        // Configurar toggle de contraseña
        function setupPasswordToggle(inputId, toggleId, eyeOpenId, eyeClosedId) {
            const passwordInput = document.getElementById(inputId);
            const toggle = document.getElementById(toggleId);
            const eyeOpen = document.getElementById(eyeOpenId);
            const eyeClosed = document.getElementById(eyeClosedId);
            
            if (!passwordInput || !toggle || !eyeOpen || !eyeClosed) {
                logger.warn('Elementos para toggle de contraseña no encontrados');
                return;
            }
            
            toggle.addEventListener('click', () => {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeOpen.classList.add('hidden');
                    eyeClosed.classList.remove('hidden');
                } else {
                    passwordInput.type = 'password';
                    eyeOpen.classList.remove('hidden');
                    eyeClosed.classList.add('hidden');
                }
            });
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            logger.info('DOM cargado, configurando event listeners...');
            
            // Configurar formulario de login
            loginForm.addEventListener('submit', handleLogin);
            googleLoginBtn.addEventListener('click', handleGoogleLogin);
            
            // Configurar toggle de contraseña
            setupPasswordToggle('login-password', 'login-toggle', 'login-eye-open', 'login-eye-closed');
            
            // Validación en tiempo real para email
            const emailInput = document.getElementById('login-email');
            emailInput.addEventListener('blur', () => {
                const email = emailInput.value.trim();
                if (email && !APP_CONFIG.UTILS.validateEmail(email)) {
                    loginErrorMessage.textContent = 'Formato de email inválido';
                } else if (loginErrorMessage.textContent === 'Formato de email inválido') {
                    loginErrorMessage.textContent = '';
                }
            });
            
            // Enter en password también envía el formulario
            document.getElementById('login-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin(e);
                }
            });
        });
        
        // Registrar Service Worker para funcionalidad offline
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    logger.info('Service Worker registrado:', registration.scope);
                    
                    // Escuchar actualizaciones del SW
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                logger.info('Nueva versión disponible');
                                // Opcional: mostrar notificación de actualización
                            }
                        });
                    });
                    
                } catch (error) {
                    logger.warn('Error registrando Service Worker:', error);
                }
            }
        }
        
        // Inicializar cuando esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initializeApp();
                registerServiceWorker();
            });
        } else {
            initializeApp();
            registerServiceWorker();
        }
        
        // Manejar errores no capturados
        window.addEventListener('unhandledrejection', (event) => {
            logger.error('Error no manejado:', event.reason);
            showError('Ha ocurrido un error inesperado. Por favor recarga la página.');
        });
    </script>
</body>
</html>
