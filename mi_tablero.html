<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Tablero - Papiro Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f0f0f; }
        .project-card {
            transition: transform 0.2s ease-in-out;
            aspect-ratio: 1 / 1;
        }
        .project-card:hover {
            transform: translateY(-5px);
        }
        .project-actions {
            display: none;
            gap: 0.5rem;
        }
        .project-card:hover .project-actions {
            display: flex;
        }
        .editable-title-input {
            background-color: transparent;
            border: 1px solid #4a4a4a;
            padding: 4px;
            border-radius: 4px;
        }
        #projects-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
        }
    </style>
</head>
<body class="text-white">
    <header class="bg-[#181818] border-b border-[#2a2a2a] py-4 px-8 flex justify-between items-center sticky top-0 z-10">
        <h1 class="text-2xl font-bold text-white">Mi Tablero</h1>
        <div class="flex items-center gap-4">
             <input type="text" id="search-input" placeholder="Buscar tableros..." class="bg-[#2a2a2a] text-white border-none rounded-lg px-4 py-2 focus:ring-2 focus:ring-[#88c999]">
            <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">Cerrar Sesi√≥n</button>
        </div>
    </header>

    <main class="p-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-semibold text-gray-200">Mis Tableros de Estudio</h2>
            <button id="add-project-btn" class="bg-[#88c999] text-[#1C1C1C] font-bold py-2 px-6 rounded-lg hover:brightness-110 transition">Nuevo Tablero</button>
        </div>
        <div id="projects-container">
            </div>
         <p id="no-projects-message" class="text-center text-gray-500 mt-10" style="display: none;">No tienes tableros a√∫n. ¬°Crea uno para empezar!</p>
    </main>

    <script type="module">
        import { auth, db, storage } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { collection, query, where, getDocs, addDoc, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { ref, deleteObject, listAll } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js";

        const projectsContainer = document.getElementById('projects-container');
        const noProjectsMessage = document.getElementById('no-projects-message');
        const addProjectBtn = document.getElementById('add-project-btn');
        const searchInput = document.getElementById('search-input');
        const logoutBtn = document.getElementById('logout-btn');
        let currentUser;
        let allProjects = [];

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                loadProjects();
            } else {
                window.location.href = 'index.html';
            }
        });

        const loadProjects = async () => {
            if (!currentUser) return;
            const q = query(collection(db, "users", currentUser.uid, "projects"));
            const querySnapshot = await getDocs(q);
            allProjects = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            allProjects.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
            displayProjects();
        };

        const displayProjects = () => {
            const filter = searchInput.value.toLowerCase();
            const filteredProjects = allProjects.filter(project => project.name.toLowerCase().includes(filter));

            projectsContainer.innerHTML = '';
            if (filteredProjects.length === 0) {
                noProjectsMessage.style.display = filter ? 'none' : 'block';
            } else {
                noProjectsMessage.style.display = 'none';
            }

            filteredProjects.forEach(project => {
                const card = document.createElement('div');
                card.className = 'project-card bg-[#181818] rounded-lg p-4 flex flex-col justify-between border border-[#2a2a2a]';
                card.innerHTML = `
                    <div class="flex-grow">
                        <div class="aspect-w-1 aspect-h-1 mb-4 bg-[#2a2a2a] rounded-md overflow-hidden flex items-center justify-center">
                            ${project.coverUrl ? `<img src="${project.coverUrl}" class="object-cover w-full h-full">` : `<span class="text-gray-500 text-sm">Sin Portada</span>`}
                        </div>
                        <input type="text" value="${project.name}" class="editable-title-input w-full text-lg font-semibold text-white bg-transparent border-0 focus:border focus:border-[#88c999] rounded-md p-1" readonly>
                    </div>
                    <div class="project-actions mt-2 flex justify-center items-center h-8">
                        <button class="rename-btn text-gray-400 hover:text-white" title="Renombrar">‚úèÔ∏è</button>
                        <button class="save-btn text-gray-400 hover:text-white" title="Guardar" style="display:none;">‚úîÔ∏è</button>
                        <button class="delete-btn text-red-500 hover:text-red-400" title="Borrar">üóëÔ∏è</button>
                    </div>
                `;

                card.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'svg' && e.target.tagName !== 'path') {
                        window.location.href = `espacio.html?id=${project.id}`;
                    }
                });

                const titleInput = card.querySelector('.editable-title-input');
                const renameBtn = card.querySelector('.rename-btn');
                const saveBtn = card.querySelector('.save-btn');
                const deleteBtn = card.querySelector('.delete-btn');
                
                renameBtn.addEventListener('click', () => {
                    titleInput.readOnly = false;
                    titleInput.focus();
                    titleInput.select();
                    renameBtn.style.display = 'none';
                    saveBtn.style.display = 'inline-block';
                });

                saveBtn.addEventListener('click', () => {
                    const newName = titleInput.value.trim();
                    if (newName && newName !== project.name) {
                        updateProjectName(project.id, newName);
                        project.name = newName; // Actualizaci√≥n local para reflejo inmediato
                    }
                    titleInput.readOnly = true;
                    renameBtn.style.display = 'inline-block';
                    saveBtn.style.display = 'none';
                });
                
                deleteBtn.addEventListener('click', () => {
                    if (confirm(`¬øEst√°s seguro de que quieres borrar el tablero "${project.name}"? Esta acci√≥n es irreversible.`)) {
                        deleteProject(project.id, project.coverUrl).then(() => {
                           card.remove();
                           allProjects = allProjects.filter(p => p.id !== project.id);
                           if (allProjects.length === 0) noProjectsMessage.style.display = 'block';
                        });
                    }
                });
                
                projectsContainer.appendChild(card);
            });
        };
        
        addProjectBtn.addEventListener('click', async () => {
            const newProjectName = prompt("Nombre del nuevo tablero de estudio:", "Nuevo Tablero");
            if (newProjectName && newProjectName.trim()) {
                try {
                    const docRef = await addDoc(collection(db, "users", currentUser.uid, "projects"), {
                        name: newProjectName.trim(),
                        createdAt: serverTimestamp(),
                        coverUrl: null
                    });
                    loadProjects(); // Recargar para mostrar el nuevo proyecto
                } catch (error) {
                    console.error("Error al crear tablero: ", error);
                    alert("No se pudo crear el tablero.");
                }
            }
        });

        const updateProjectName = async (projectId, newName) => {
            const projectDocRef = doc(db, "users", currentUser.uid, "projects", projectId);
            try {
                await updateDoc(projectDocRef, { name: newName });
            } catch (error) {
                console.error("Error al actualizar el nombre:", error);
                alert("No se pudo actualizar el nombre del tablero.");
            }
        };

        // ==============================================================
        // CORRECCI√ìN: Funci√≥n de borrado robusta
        const deleteProject = async (projectId, coverUrl) => {
            try {
                // 1. Borrar portada (si existe), continuando incluso si falla
                if (coverUrl) {
                    const coverRef = ref(storage, coverUrl);
                    await deleteObject(coverRef).catch(error => {
                        console.error("Fallo al borrar portada, se continuar√° con el resto:", error);
                    });
                }

                // 2. Listar y borrar todos los archivos dentro de la carpeta del proyecto en Storage
                const projectStorageRef = ref(storage, `${currentUser.uid}/${projectId}`);
                const filesList = await listAll(projectStorageRef);
                await Promise.all(filesList.items.map(fileRef => deleteObject(fileRef)));

                // 3. Listar y borrar todos los documentos en la subcolecci√≥n 'pdfs'
                const pdfsCollectionRef = collection(db, "users", currentUser.uid, "projects", projectId, "pdfs");
                const pdfDocsSnapshot = await getDocs(pdfsCollectionRef);
                await Promise.all(pdfDocsSnapshot.docs.map(pdfDoc => deleteDoc(pdfDoc.ref)));

                // 4. Finalmente, borrar el documento principal del proyecto
                const projectDocRef = doc(db, "users", currentUser.uid, "projects", projectId);
                await deleteDoc(projectDocRef);

            } catch (error) {
                console.error("Error cr√≠tico durante el borrado del tablero:", error);
                alert("No se pudo borrar completamente el tablero. Podr√≠an haber quedado datos residuales. Por favor, contacta a soporte si el problema persiste.");
                // Lanzar el error para que el ".then()" en el event listener no se ejecute
                throw error;
            }
        };
        // ==============================================================

        searchInput.addEventListener('keyup', displayProjects);

        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>
