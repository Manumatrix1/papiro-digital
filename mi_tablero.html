<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mis Tableros - Papiro Digital</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <nav class="navbar">
        <div class="logo">Papiro Digital</div>
        <div>
            <span id="user-info"></span>
            <button id="logout-btn" class="btn btn-danger">Cerrar Sesión</button>
        </div>
    </nav>

    <div class="container">
        <h2>Mis Tableros</h2>
        
        <div id="create-project-form">
            <h3>Crear Nuevo Tablero</h3>
            <input type="text" id="project-name" placeholder="Nombre del tema (ej. Neurociencia)">
            <button id="create-project-btn" class="btn">Crear Tablero</button>
        </div>

        <div id="project-grid" class="project-grid">
            </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        const userInfo = document.getElementById('user-info');
        const projectGrid = document.getElementById('project-grid');
        const createProjectBtn = document.getElementById('create-project-btn');
        const logoutBtn = document.getElementById('logout-btn');

        let currentUser;

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                userInfo.textContent = `Hola, ${user.email}`;
                loadProjects(user.uid);
            } else {
                window.location.href = 'index.html';
            }
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        // Cargar proyectos del usuario
        async function loadProjects(userId) {
            const projectsRef = db.collection('users').doc(userId).collection('projects');
            projectsRef.onSnapshot(snapshot => {
                projectGrid.innerHTML = ''; // Limpiar la grilla
                if (snapshot.empty) {
                    projectGrid.innerHTML = "<p>Aún no tienes tableros. ¡Crea el primero!</p>";
                    return;
                }
                snapshot.forEach(doc => {
                    const project = doc.data();
                    const projectId = doc.id;
                    const card = document.createElement('div');
                    card.className = 'project-card';
                    card.innerHTML = `
                        <h3>${project.name}</h3>
                        <p>Creado: ${project.createdAt.toDate().toLocaleDateString()}</p>
                        <div class="project-card-actions">
                            <a href="espacio.html?projectId=${projectId}" class="btn">Abrir</a>
                            <button class="btn btn-danger" onclick="deleteProject('${projectId}')">Borrar</button>
                        </div>
                    `;
                    projectGrid.appendChild(card);
                });
            });
        }

        // Crear un nuevo proyecto
        createProjectBtn.addEventListener('click', async () => {
            const projectNameInput = document.getElementById('project-name');
            const projectName = projectNameInput.value.trim();

            if (projectName && currentUser) {
                await db.collection('users').doc(currentUser.uid).collection('projects').add({
                    name: projectName,
                    owner: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                projectNameInput.value = ''; // Limpiar el input
            } else {
                alert('Por favor, introduce un nombre para el tablero.');
            }
        });

        // Borrar un proyecto (Función global para el onclick)
        async function deleteProject(projectId) {
            if (confirm('¿Estás seguro de que quieres borrar este tablero y todo su contenido?')) {
                await db.collection('users').doc(currentUser.uid).collection('projects').doc(projectId).delete();
                // Nota: Borrar los archivos de Storage requeriría una Cloud Function para hacerlo de forma segura y completa.
            }
        }
    </script>
</body>
</html>
