<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Proyectos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="style.css"> 
</head>
<body class="bg-gray-900 text-white">

    <header class="bg-gray-800 p-4 flex justify-between items-center">
        <h1 class="text-xl font-bold">Mis Proyectos</h1>
        <button id="logout-btn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition-colors">
            Cerrar Sesión
        </button>
    </header>

    <main class="p-6">
        <div id="projects-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
            </div>
    </main>

    <script type="module">
        // 1. Importamos los servicios desde nuestro archivo central
        import { auth, db } from './firebase-config.js';
        
        // 2. Importamos las funciones que necesitamos para esta página
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { collection, query, getDocs } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        const projectsContainer = document.getElementById('projects-container');
        const logoutBtn = document.getElementById('logout-btn');

        // 3. Verificamos el estado de la sesión
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Si el usuario está logueado, cargamos sus proyectos
                loadProjects(user.uid);
            } else {
                // Si no hay sesión, lo mandamos al login
                window.location.href = 'index.html';
            }
        });

        // 4. Función para cargar los proyectos del usuario
        async function loadProjects(userId) {
            try {
                const projectsRef = collection(db, 'users', userId, 'projects');
                const q = query(projectsRef);
                const querySnapshot = await getDocs(q);
                
                projectsContainer.innerHTML = ''; // Limpiamos el contenedor
                
                querySnapshot.forEach((doc) => {
                    const project = doc.data();
                    const projectEl = document.createElement('a');
                    projectEl.href = `tablero_detalle.html?id=${doc.id}`;
                    projectEl.className = 'block bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-blue-500 transition-all';
                    projectEl.innerHTML = `
                        <div class="flex flex-col items-center text-center">
                            <i class="fas fa-book-open text-4xl text-gray-400 mb-3"></i>
                            <h3 class="font-semibold truncate w-full">${project.name}</h3>
                        </div>
                    `;
                    projectsContainer.appendChild(projectEl);
                });
            } catch (error) {
                console.error("Error al cargar los proyectos:", error);
                projectsContainer.innerHTML = '<p class="text-red-500">No se pudieron cargar los proyectos.</p>';
            }
        }

        // 5. Funcionalidad del botón para cerrar sesión
        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch(error => console.error("Error al cerrar sesión:", error));
        });
    </script>

</body>
</html>
