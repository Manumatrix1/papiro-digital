<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espacio de Trabajo - Papiro Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f0f0f; }
        #pdf-render { box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #pdf-loader-container { display: none; }
    </style>
</head>
<body class="text-white">
    <header class="bg-[#181818] border-b border-[#2a2a2a] py-3 px-8 flex justify-between items-center sticky top-0 z-10">
        <input id="project-title" type="text" class="bg-transparent text-2xl font-bold text-white focus:outline-none" value="Cargando...">
        <div class="flex items-center gap-4">
            <button id="save-btn" class="bg-[#88c999] text-[#1C1C1C] font-bold py-2 px-4 rounded-lg hover:brightness-110 transition">Guardar Título</button>
            <a href="mi_tablero.html" class="text-gray-300 hover:text-white transition">Volver al Tablero</a>
        </div>
    </header>
    <main class="p-8">
        <div id="upload-container" class="mb-4 text-center py-10 border-2 border-dashed border-gray-700 rounded-lg hidden">
            <p id="upload-message" class="text-gray-400 mb-4">Este proyecto aún no tiene un PDF asignado.</p>
            <input type="file" id="pdf-input" class="hidden" accept=".pdf">
            <button id="upload-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition">Seleccionar PDF para Cargar</button>
            <div id="pdf-loader-container" class="mt-4">
                <div class="w-full bg-gray-700 rounded-full h-2.5"><div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div></div>
                <p id="progress-text" class="text-white mt-2">Cargando... 0%</p>
            </div>
        </div>
        <div id="viewer-container" class="hidden">
            <div class="flex items-center justify-center gap-4 mb-4">
                <button id="prev-page" class="bg-gray-700 hover:bg-gray-600 font-bold py-2 px-4 rounded-lg transition">Anterior</button>
                <span id="page-num" class="text-lg"></span> / <span id="page-count" class="text-lg"></span>
                <button id="next-page" class="bg-gray-700 hover:bg-gray-600 font-bold py-2 px-4 rounded-lg transition">Siguiente</button>
            </div>
            <div class="flex justify-center"><canvas id="pdf-render"></canvas></div>
        </div>
    </main>
    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
    <script type="module">
        import { auth, db, storage } from './firebase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js";

        // Se asegura de que la librería PDF.js esté disponible
        const { pdfjsLib } = window;
        if (pdfjsLib) { 
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://mozilla.github.io/pdf.js/build/pdf.worker.js'; 
        }

        const projectTitleEl = document.getElementById('project-title'), uploadContainer = document.getElementById('upload-container'), pdfInput = document.getElementById('pdf-input'), uploadBtn = document.getElementById('upload-btn'), pdfLoaderContainer = document.getElementById('pdf-loader-container'), progressBar = document.getElementById('progress-bar'), progressText = document.getElementById('progress-text'), viewerContainer = document.getElementById('viewer-container'), saveBtn = document.getElementById('save-btn'), prevPageBtn = document.getElementById('prev-page'), nextPageBtn = document.getElementById('next-page');
        let currentProjectRef = null, currentUser = null;
        
        let pdfDoc = null, pageNum = 1, pageRendering = false, pageNumPending = null;
        const scale = 1.5, canvas = document.getElementById('pdf-render'), ctx = canvas.getContext('2d');

        function renderPage(num) {
            pageRendering = true;
            if (!pdfDoc) return;
            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                const renderContext = { canvasContext: ctx, viewport: viewport };
                page.render(renderContext).promise.then(() => {
                    pageRendering = false;
                    if (pageNumPending !== null) { renderPage(pageNumPending); pageNumPending = null; }
                });
            });
            document.getElementById('page-num').textContent = num;
        }

        function queueRenderPage(num) { if (pageRendering) { pageNumPending = num; } else { renderPage(num); } }
        const onPrevPage = () => { if (pageNum <= 1) return; pageNum--; queueRenderPage(pageNum); };
        const onNextPage = () => { if (!pdfDoc || pageNum >= pdfDoc.numPages) return; pageNum++; queueRenderPage(pageNum); };
        
        async function loadPdf(url) {
            if (!pdfjsLib) {
                console.error("PDF.js no está cargado.");
                document.getElementById('upload-message').textContent = "Error: La librería de PDF no está disponible.";
                document.getElementById('upload-container').style.display = 'block';
                return;
            }
            
            try {
                const loadingTask = pdfjsLib.getDocument(url);
                pdfDoc = await loadingTask.promise;
                document.getElementById('page-count').textContent = pdfDoc.numPages;
                renderPage(pageNum);
                uploadContainer.style.display = 'none';
                viewerContainer.classList.remove('hidden');
            } catch (error) {
                 console.error("Error al cargar el PDF:", error);
                 document.getElementById('upload-message').textContent = "No se pudo cargar el PDF. Revisa la URL y los permisos.";
                 document.getElementById('upload-container').style.display = 'block';
            }
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const projectId = new URLSearchParams(window.location.search).get('id');
                if (!projectId) { window.location.href = 'mi_tablero.html'; return; }
                currentProjectRef = doc(db, "users", user.uid, "projects", projectId);
                
                try {
                    const projectDoc = await getDoc(currentProjectRef);
                    if (projectDoc.exists()) {
                        const projectData = projectDoc.data();
                        projectTitleEl.value = projectData.name || "Proyecto sin título";
                        if (projectData.pdfUrl) { 
                            viewerContainer.style.display = 'block';
                            uploadContainer.style.display = 'none';
                            loadPdf(projectData.pdfUrl); 
                        } else { 
                            uploadContainer.classList.remove('hidden');
                            uploadContainer.style.display = 'block'; 
                            viewerContainer.style.display = 'none';
                        }
                    } else { console.error("El proyecto no existe."); window.location.href = 'mi_tablero.html'; }
                } catch (e) { console.error("Error obteniendo el documento:", e); window.location.href = 'mi_tablero.html';}

            } else { window.location.href = 'index.html'; }
        });

        uploadBtn.addEventListener('click', () => pdfInput.click());

        pdfInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file || file.type !== 'application/pdf') { alert("Por favor, selecciona un archivo PDF."); return; }
            
            const storageRef = ref(storage, `pdfs/${currentUser.uid}/${currentProjectRef.id}/${file.name}`);
            const uploadTask = uploadBytesResumable(storageRef, file);

            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    pdfLoaderContainer.style.display = 'block';
                    progressBar.style.width = progress + '%';
                    progressText.textContent = `Cargando... ${Math.round(progress)}%`;
                }, 
                (error) => { 
                    console.error("Error al subir:", error); 
                    alert("Hubo un error al subir el PDF."); 
                    pdfLoaderContainer.style.display = 'none'; 
                }, 
                async () => {
                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                    await updateDoc(currentProjectRef, { pdfUrl: downloadURL });
                    location.reload();
                }
            );
        });

        saveBtn.addEventListener('click', async () => {
            if (!currentProjectRef) return;
            saveBtn.textContent = "Guardando...";
            saveBtn.disabled = true;
            try {
                await updateDoc(currentProjectRef, { name: projectTitleEl.value });
                saveBtn.textContent = "¡Guardado!";
                setTimeout(() => { 
                    saveBtn.textContent = "Guardar Título"; 
                    saveBtn.disabled = false;
                }, 2000);
            } catch (error) { 
                console.error("Error al guardar:", error); 
                alert("No se pudo guardar el título."); 
                saveBtn.textContent = "Guardar Título";
                saveBtn.disabled = false;
            }
        });

        prevPageBtn.addEventListener('click', onPrevPage);
        nextPageBtn.addEventListener('click', onNextPage);
    </script>
</body>
</html>
