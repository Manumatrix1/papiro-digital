<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Cargando...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f0f0f;
            overflow: hidden; /* Evita doble scroll */
        }
        
        /* Contenedor principal que ocupa toda la pantalla */
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Área del PDF con scroll vertical */
        .pdf-viewer-area {
            flex-grow: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
            background-color: #1a1a1a;
            position: relative; /* Para posicionar los subrayados */
        }

        .pdf-page-container {
            position: relative; /* Clave para el subrayado */
            margin: 0 auto 1rem auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* --- NUEVO: Estilos para el Subrayado --- */
        .text-layer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            opacity: 0.3;
            line-height: 1.0;
        }
        .text-layer > span {
            color: transparent;
            position: absolute;
            white-space: pre;
            cursor: text;
            transform-origin: 0% 0%;
        }
        /* Color del subrayado */
        ::selection { background: rgba(255, 221, 0, 0.4); }

        /* --- NUEVO: Barra de herramientas inferior, más compacta --- */
        .bottom-toolbar {
            flex-shrink: 0; /* No se encoge */
            background-color: #181818;
            border-top: 1px solid #2a2a2a;
        }

        /* --- NUEVO: Panel lateral de notas (oculto en móvil) --- */
        #notes-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background-color: #181818;
            border-left: 1px solid #2a2a2a;
            transform: translateX(100%); /* Oculto por defecto */
            transition: transform 0.3s ease-in-out;
            z-index: 50;
            display: flex;
            flex-direction: column;
        }
        #notes-sidebar.open {
            transform: translateX(0);
        }
        #notes-list-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        /* Overlay para cerrar el panel al tocar fuera */
        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 49;
            display: none;
        }
        #sidebar-overlay.open {
            display: block;
        }

    </style>
</head>
<body class="text-white">

    <div class="app-container">
        <header class="bg-[#181818] border-b border-[#2a2a2a] py-2 px-3 flex justify-between items-center w-full flex-shrink-0">
            <a href="mi_tablero.html" class="p-2 rounded-md hover:bg-[#2a2a2a]"><i class="fas fa-arrow-left"></i></a>
            <h1 id="project-title" class="text-md font-bold text-white truncate mx-2">Cargando...</h1>
            <div class="flex items-center gap-2">
                 <button id="open-notes-btn" class="p-2 rounded-md hover:bg-[#2a2a2a]"><i class="fas fa-book"></i></button>
            </div>
        </header>

        <main id="pdf-viewer-area" class="pdf-viewer-area">
            </main>

        <footer class="bottom-toolbar p-2 flex items-center justify-around w-full">
            <button id="read-aloud-btn" class="p-2 rounded-md hover:bg-[#2a2a2a]" title="Leer en voz alta">
                <i class="fas fa-volume-up"></i>
            </button>
            <button id="highlight-btn" class="p-2 rounded-md hover:bg-[#2a2a2a]" title="Añadir nota al texto seleccionado">
                <i class="fas fa-highlighter"></i>
            </button>
             <div class="flex items-center gap-2">
                <button id="prev-page-btn" class="p-2 rounded-md hover:bg-[#2a2a2a]"><i class="fas fa-chevron-left"></i></button>
                <span id="page-indicator" class="text-sm">0 / 0</span>
                <button id="next-page-btn" class="p-2 rounded-md hover:bg-[#2a2a2a]"><i class="fas fa-chevron-right"></i></button>
            </div>
        </footer>
    </div>

    <div id="sidebar-overlay"></div>
    <aside id="notes-sidebar" class="p-4">
        <div class="flex items-center justify-between mb-4 flex-shrink-0">
            <h2 class="text-xl font-bold">Anotaciones</h2>
            <button id="close-notes-btn" class="p-2 rounded-md hover:bg-[#2a2a2a]"><i class="fas fa-times"></i></button>
        </div>
        <div id="notes-list-container" class="space-y-3">
            <p id="no-notes-message" class="text-gray-500 text-center mt-4">No hay notas.</p>
        </div>
    </aside>

    <script type="module">
        // Importaciones de Firebase (sin cambios)
        import { auth, db, storage } from './firebase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { doc, onSnapshot, collection, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // Elementos del DOM
        const projectTitleEl = document.getElementById('project-title');
        const viewerArea = document.getElementById('pdf-viewer-area');
        const pageIndicator = document.getElementById('page-indicator');
        const openNotesBtn = document.getElementById('open-notes-btn');
        const closeNotesBtn = document.getElementById('close-notes-btn');
        const notesSidebar = document.getElementById('notes-sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const notesListContainer = document.getElementById('notes-list-container');
        const noNotesMessage = document.getElementById('no-notes-message');
        const readAloudBtn = document.getElementById('read-aloud-btn');
        const highlightBtn = document.getElementById('highlight-btn');

        // Variables de estado
        let currentUser, projectId, pdfId, projectRef;
        let pdfDocument = null;
        let currentPageNum = 1;
        
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
             onAuthStateChanged(auth, (user) => {
                if (!user) { window.location.href = 'index.html'; return; }
                currentUser = user;
                const urlParams = new URLSearchParams(window.location.search);
                projectId = urlParams.get('id');
                pdfId = urlParams.get('pdfId');
                if (!projectId || !pdfId) { window.location.href = 'mi_tablero.html'; return; }
                
                projectRef = doc(db, "users", user.uid, "projects", projectId);
                loadPdfDocument();
                setupEventListeners();
                loadNotes();
            });
        });

        async function loadPdfDocument() {
            const pdfDocRef = doc(projectRef, 'pdfs', pdfId);
            const pdfSnap = await onSnapshot(pdfDocRef, async (doc) => {
                if (!doc.exists()) { console.error("PDF no encontrado"); return; }
                projectTitleEl.textContent = doc.data().name;
                const loadingTask = pdfjsLib.getDocument(doc.data().url);
                pdfDocument = await loadingTask.promise;
                updatePageIndicator();
                renderAllPages();
            });
        }
        
        // --- RENDERIZADO DEL PDF (con capa de texto para seleccionar) ---
        async function renderAllPages() {
            viewerArea.innerHTML = '';
            for (let i = 1; i <= pdfDocument.numPages; i++) {
                const page = await pdfDocument.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });
                
                const pageContainer = document.createElement('div');
                pageContainer.className = 'pdf-page-container';
                pageContainer.dataset.pageNumber = i;

                const canvas = document.createElement('canvas');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                pageContainer.style.width = `${viewport.width}px`;
                pageContainer.style.height = `${viewport.height}px`;

                const textLayerDiv = document.createElement("div");
                textLayerDiv.className = "text-layer";
                
                pageContainer.appendChild(canvas);
                pageContainer.appendChild(textLayerDiv);
                viewerArea.appendChild(pageContainer);

                page.render({ canvasContext: canvas.getContext('2d'), viewport });
                
                const textContent = await page.getTextContent();
                pdfjsLib.renderTextLayer({
                    textContentSource: textContent,
                    container: textLayerDiv,
                    viewport: viewport,
                    textDivs: []
                });
            }
        }

        // --- NAVEGACIÓN Y UI ---
        function setupEventListeners() {
            openNotesBtn.addEventListener('click', () => {
                notesSidebar.classList.add('open');
                sidebarOverlay.classList.add('open');
            });
            const closeSidebar = () => {
                notesSidebar.classList.remove('open');
                sidebarOverlay.classList.remove('open');
            };
            closeNotesBtn.addEventListener('click', closeSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar);

            viewerArea.addEventListener('scroll', () => {
                // Actualizar indicador de página al hacer scroll
                // ... (lógica para detectar la página más visible) ...
                updatePageIndicator();
            });
            
            // --- NUEVO: Listeners de herramientas ---
            readAloudBtn.addEventListener('click', toggleReadAloud);
            highlightBtn.addEventListener('click', addHighlightNote);
        }

        function updatePageIndicator() {
            // (Una lógica simple por ahora)
            pageIndicator.textContent = `${currentPageNum} / ${pdfDocument ? pdfDocument.numPages : 0}`;
        }
        
        // --- NUEVO: FUNCIONALIDAD DE LECTURA POR VOZ ---
        let isReading = false;
        function toggleReadAloud() {
            if (isReading) {
                speechSynthesis.cancel();
                isReading = false;
                readAloudBtn.classList.remove('text-[#88c999]');
                return;
            }
            
            const selection = window.getSelection();
            let textToRead = selection.toString();
            
            if (!textToRead) {
                Swal.fire('Selecciona primero el texto que quieres escuchar.', '', 'info');
                return;
            }
            
            isReading = true;
            readAloudBtn.classList.add('text-[#88c999]');
            const utterance = new SpeechSynthesisUtterance(textToRead);
            utterance.lang = 'es-ES';
            utterance.onend = () => {
                isReading = false;
                readAloudBtn.classList.remove('text-[#88c999]');
            };
            speechSynthesis.speak(utterance);
        }

        // --- NUEVO: FUNCIONALIDAD DE SUBRAYADO Y NOTAS ---
        async function addHighlightNote() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            if (!selectedText) {
                Swal.fire('Selecciona el texto a subrayar antes de añadir una nota.', '', 'info');
                return;
            }
            
            const { value: noteText } = await Swal.fire({
                title: 'Añadir nota al subrayado',
                input: 'textarea',
                inputPlaceholder: 'Escribe tu nota aquí...',
                confirmButtonText: 'Guardar',
                showCancelButton: true
            });

            if (noteText) {
                const notesCollectionRef = collection(doc(projectRef, 'pdfs', pdfId), 'notes');
                await addDoc(notesCollectionRef, {
                    highlightedText: selectedText,
                    note: noteText,
                    page: currentPageNum, // Simplificado, idealmente se detecta la página del texto
                    createdAt: new Date()
                });
            }
        }

        function loadNotes() {
            const notesQuery = query(collection(doc(projectRef, 'pdfs', pdfId), 'notes'), orderBy('createdAt', 'desc'));
            onSnapshot(notesQuery, (snapshot) => {
                notesListContainer.innerHTML = '';
                if(snapshot.empty) {
                    notesListContainer.appendChild(noNotesMessage);
                    return;
                }
                snapshot.forEach(doc => {
                    const noteData = doc.data();
                    const noteCard = document.createElement('div');
                    noteCard.className = 'bg-[#2a2a2a] p-3 rounded-lg';
                    noteCard.innerHTML = `
                        <p class="text-sm font-semibold text-yellow-300">"${noteData.highlightedText}"</p>
                        <p class="text-white mt-2">${noteData.note}</p>
                        <span class="text-xs text-gray-400 mt-2 block">Página ${noteData.page}</span>
                    `;
                    notesListContainer.appendChild(noteCard);
                });
            });
        }
    </script>
</body>
</html>
