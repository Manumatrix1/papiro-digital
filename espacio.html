<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Espacio de Trabajo - Papiro Digital</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::selection { background-color: #88c999; color: #1C1C1C; }
        #pdf-container { position: relative; }
        .textLayer { position: absolute; left: 0; top: 0; right: 0; bottom: 0; opacity: 0.2; line-height: 1.0; }
        .textLayer > span { color: transparent; position: absolute; white-space: pre; cursor: text; transform-origin: 0% 0%; }
        /* Estilo para la notificación de guardado */
        #save-notification {
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
    </style>
</head>
<body class="bg-[#0f0f0f] text-white">
    <!-- Notificación de Guardado -->
    <div id="save-notification" class="fixed top-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 translate-y-[-20px] z-50">
        ¡Proyecto guardado con éxito!
    </div>

    <div class="min-h-screen bg-gradient-to-b from-[#1c1c1c] to-[#0f0f0f] px-4 sm:px-6 py-10">
        <div class="max-w-5xl mx-auto">
            
            <header class="mb-10 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <a href="dashboard.html" class="text-[#88c999] hover:underline text-sm mb-2 block">&larr; Volver al Dashboard</a>
                    <input type="text" id="project-title" placeholder="Título de tu Proyecto" class="text-4xl font-bold bg-transparent text-white focus:outline-none w-full border-b-2 border-transparent focus:border-[#88c999] transition-colors">
                </div>
                <button id="save-project" class="bg-[#88c999] text-[#1C1C1C] px-6 py-3 rounded-xl font-semibold hover:brightness-110 transition shadow-lg w-full sm:w-auto flex-shrink-0">
                    💾 Guardar Proyecto
                </button>
            </header>

            <section class="mb-10">
                <label class="block text-[#88c999] text-lg mb-2 font-semibold">📄 Archivo PDF</label>
                <div id="pdf-info" class="hidden items-center gap-4 bg-[#1c1c1c] p-3 rounded-lg mb-2">
                    <span id="pdf-name" class="text-gray-300"></span>
                    <button id="remove-pdf" class="text-red-500 hover:text-red-400 text-sm font-semibold">Quitar</button>
                </div>
                <input type="file" id="pdf-upload" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-[#88c999] file:text-[#1C1C1C] hover:file:brightness-110" accept="application/pdf" />
            </section>
            
            <section id="pdf-viewer" class="bg-[#121212] rounded-2xl p-4 sm:p-6 shadow-xl mb-10 hidden">
                <div id="pdf-controls" class="flex items-center justify-between mb-4">
                    <button id="prev-page" class="bg-[#333] px-4 py-2 rounded-lg font-semibold hover:bg-[#444] transition disabled:opacity-50">Anterior</button>
                    <span id="page-num" class="text-gray-400"></span>
                    <button id="next-page" class="bg-[#333] px-4 py-2 rounded-lg font-semibold hover:bg-[#444] transition disabled:opacity-50">Siguiente</button>
                </div>
                <div id="pdf-container" class="w-full rounded-xl overflow-auto">
                    <canvas id="pdf-canvas"></canvas>
                    <div id="text-layer" class="textLayer"></div>
                </div>
            </section>

            <section id="highlight-section" class="mb-10 hidden">
                <button id="save-highlight" class="hidden bg-[#88c999] text-[#1C1C1C] px-4 py-2 rounded-xl font-semibold hover:brightness-110 transition">Añadir subrayado al proyecto</button>
                <p id="highlight-text" class="mt-2 text-sm italic text-gray-400"></p>
            </section>

            <section class="mb-10">
                <label class="block text-[#88c999] text-lg mb-2 font-semibold">📝 Notas personales</label>
                <textarea id="notes" class="w-full p-4 rounded-xl bg-[#1c1c1c] border border-[#333] text-gray-300 focus:ring-2 focus:ring-[#88c999] focus:outline-none transition" rows="8" placeholder="Escribí tus pensamientos aquí..."></textarea>
            </section>

            <section class="mb-10">
                <label class="block text-[#88c999] text-lg mb-2 font-semibold">🎥 Link de YouTube</label>
                <input type="text" id="youtube-link" class="w-full p-3 rounded-xl bg-[#1c1c1c] text-gray-300 border border-[#333] focus:ring-2 focus:ring-[#88c999] focus:outline-none transition" placeholder="https://youtu.be/ejemplo" />
                <div class="mt-6 rounded-xl overflow-hidden aspect-video relative" id="youtube-preview"></div>
            </section>

            <section class="mb-10">
                <label class="block text-[#88c999] text-lg mb-2 font-semibold">🔍 Subrayados del Proyecto</label>
                <ul id="highlights-list" class="mt-4 space-y-3"></ul>
            </section>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let userId = null;
        let projectId = null;
        let localData = {
            title: '',
            notes: '',
            youtubeLink: '',
            highlights: [],
            pdfURL: '',
            pdfName: ''
        };

        const projectTitleInput = document.getElementById('project-title');
        const notesTextarea = document.getElementById('notes');
        const youtubeLinkInput = document.getElementById('youtube-link');
        const pdfUploadInput = document.getElementById('pdf-upload');
        const pdfInfoDiv = document.getElementById('pdf-info');
        const pdfNameSpan = document.getElementById('pdf-name');
        const removePdfBtn = document.getElementById('remove-pdf');
        
        // --- LÓGICA DE PROYECTO Y AUTENTICACIÓN ---
        
        const urlParams = new URLSearchParams(window.location.search);
        projectId = urlParams.get('id');
        if (!projectId) {
            alert('ID de proyecto no encontrado. Volviendo al dashboard.');
            window.location.href = 'dashboard.html';
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                loadProjectData();
            } else {
                window.location.replace('index.html');
            }
        });

        async function loadProjectData() {
            if (!userId || !projectId) return;
            const projectRef = doc(db, `artifacts/${appId}/users/${userId}/projects/${projectId}`);
            const projectSnap = await getDoc(projectRef);

            if (projectSnap.exists()) {
                localData = { ...localData, ...projectSnap.data() };
                projectTitleInput.value = localData.title;
                notesTextarea.value = localData.notes;
                youtubeLinkInput.value = localData.youtubeLink;
                
                updateYoutubePreview();
                updatePdfInfo();
                renderHighlights();

                if (localData.pdfURL) {
                    loadPdfFromUrl(localData.pdfURL);
                }
            }
        }

        // --- GUARDADO MANUAL ---
        document.getElementById('save-project').addEventListener('click', async () => {
            if (!userId || !projectId) return;
            
            localData.title = projectTitleInput.value;
            localData.notes = notesTextarea.value;
            localData.youtubeLink = youtubeLinkInput.value;

            const projectRef = doc(db, `artifacts/${appId}/users/${userId}/projects/${projectId}`);
            try {
                await setDoc(projectRef, { ...localData, lastSaved: new Date() }, { merge: true });
                
                const notification = document.getElementById('save-notification');
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateY(-20px)';
                }, 3000);

            } catch (error) {
                console.error("Error al guardar el proyecto:", error);
                alert('Hubo un error al guardar. Intenta de nuevo.');
            }
        });

        // --- LÓGICA DE PDF ---
        
        let pdfDoc = null;
        let currentPage = 1;
        const canvas = document.getElementById("pdf-canvas");
        const textLayerDiv = document.getElementById("text-layer");

        pdfUploadInput.addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file || !userId || !projectId) return;

            // Eliminar PDF anterior si existe
            if (localData.pdfURL) {
                await removePdf();
            }

            const pdfRef = ref(storage, `artifacts/${appId}/users/${userId}/projects/${projectId}/${file.name}`);
            try {
                const snapshot = await uploadBytes(pdfRef, file);
                const url = await getDownloadURL(snapshot.ref);
                
                localData.pdfURL = url;
                localData.pdfName = file.name;
                updatePdfInfo();
                loadPdfFromUrl(url);
            } catch (error) {
                console.error("Error al subir el PDF:", error);
                alert("No se pudo subir el PDF.");
            }
        });

        removePdfBtn.addEventListener('click', async () => {
            if (confirm(`¿Seguro que querés quitar el PDF "${localData.pdfName}"?`)) {
                await removePdf();
                localData.pdfURL = '';
                localData.pdfName = '';
                updatePdfInfo();
                document.getElementById("pdf-viewer").classList.add("hidden");
                document.getElementById("highlight-section").classList.add("hidden");
            }
        });

        async function removePdf() {
            if (!localData.pdfURL) return;
            const pdfRef = ref(storage, localData.pdfURL);
            try {
                await deleteObject(pdfRef);
            } catch (error) {
                console.error("Error al eliminar el PDF del storage:", error);
            }
        }
        
        function updatePdfInfo() {
            if (localData.pdfName) {
                pdfNameSpan.textContent = localData.pdfName;
                pdfInfoDiv.classList.remove('hidden');
                pdfUploadInput.classList.add('hidden');
            } else {
                pdfInfoDiv.classList.add('hidden');
                pdfUploadInput.classList.remove('hidden');
            }
        }

        async function loadPdfFromUrl(url) {
            try {
                const loadingTask = pdfjsLib.getDocument(url);
                pdfDoc = await loadingTask.promise;
                currentPage = 1;
                document.getElementById("pdf-viewer").classList.remove("hidden");
                document.getElementById("highlight-section").classList.remove("hidden");
                renderPage(currentPage);
            } catch (error) {
                console.error("Error al cargar el PDF desde la URL:", error);
                alert("No se pudo cargar el PDF. Puede que el archivo esté corrupto o el enlace no sea válido.");
            }
        }

        async function renderPage(num) {
            if (!pdfDoc) return;
            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale: 1.5 });
            const canvasContext = canvas.getContext("2d");
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext, viewport }).promise;
            textLayerDiv.innerHTML = "";
            const textContent = await page.getTextContent();
            pdfjsLib.renderTextLayer({ textContent, container: textLayerDiv, viewport, textDivs: [] });
            document.getElementById("page-num").textContent = `Página ${num} de ${pdfDoc.numPages}`;
            currentPage = num;
            document.getElementById("prev-page").disabled = (num <= 1);
            document.getElementById("next-page").disabled = (num >= pdfDoc.numPages);
        }
        
        document.getElementById("prev-page").addEventListener("click", () => { if (currentPage > 1) renderPage(currentPage - 1); });
        document.getElementById("next-page").addEventListener("click", () => { if (currentPage < pdfDoc.numPages) renderPage(currentPage + 1); });


        // --- SUBRAYADOS ---
        document.addEventListener("mouseup", () => {
             if (!pdfDoc) return;
             const selection = window.getSelection().toString().trim();
             const saveBtn = document.getElementById("save-highlight");
             const textP = document.getElementById("highlight-text");
             if (selection.length > 2) {
                 textP.innerText = `"${selection}"`;
                 saveBtn.classList.remove("hidden");
             } else {
                 textP.innerText = "";
                 saveBtn.classList.add("hidden");
             }
        });

        document.getElementById("save-highlight").addEventListener("click", () => {
            const text = window.getSelection().toString().trim();
            if (text) {
                localData.highlights.push({
                    text: text,
                    page: currentPage,
                    id: 'hl_' + Date.now()
                });
                renderHighlights();
            }
            window.getSelection().removeAllRanges();
            document.getElementById("highlight-text").innerText = "";
            document.getElementById("save-highlight").classList.add("hidden");
        });

        function renderHighlights() {
            const list = document.getElementById("highlights-list");
            list.innerHTML = "";
            localData.highlights.forEach((r) => {
                const li = document.createElement("li");
                li.className = "bg-[#1c1c1c] p-3 rounded-lg border border-[#333] flex justify-between items-start gap-4";
                li.innerHTML = `
                    <div class="cursor-pointer flex-grow" onclick="window.renderPage(${r.page})">
                        <p class="text-gray-300">${r.text}</p>
                        <span class="text-xs text-gray-500">Página ${r.page}</span>
                    </div>
                    <button data-id="${r.id}" class="delete-highlight-btn text-gray-500 hover:text-red-500 transition p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                `;
                list.appendChild(li);
            });
            
            document.querySelectorAll('.delete-highlight-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const highlightId = btn.dataset.id;
                    localData.highlights = localData.highlights.filter(h => h.id !== highlightId);
                    renderHighlights();
                });
            });
        }
        window.renderPage = renderPage; // Hacerla global para el onclick

        // --- VIDEO DE YOUTUBE ---
        youtubeLinkInput.addEventListener("input", updateYoutubePreview);

        function updateYoutubePreview() {
            const link = youtubeLinkInput.value;
            const youtubeIdRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = link.match(youtubeIdRegex);
            const id = match ? match[1] : null;
            const previewDiv = document.getElementById("youtube-preview");
            if (id) {
                previewDiv.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${id}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="rounded-xl absolute top-0 left-0 w-full h-full"></iframe>`;
            } else {
                previewDiv.innerHTML = "";
            }
        }
    </script>
</body>
</html>
