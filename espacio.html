<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Papiro Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary-color: #88c999; --background-color: #0f0f0f; --surface-color: #181818; --surface-border-color: #2a2a2a; }
        .hidden { display: none !important; }
        html { height: 100%; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-color); color: white; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; padding: 1rem; }
        #pdf-viewer-container { flex-grow: 1; display: flex; flex-direction: column; }
        #pages-container { overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; }
        .pdf-page-container { position: relative; margin: 0 auto 1rem auto; max-width: 100%; }
        .pdf-page-container canvas, .textLayer { width: 100% !important; height: auto !important; display: block; }
        .annotation-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; touch-action: none; }
        #annotation-toolbar { position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); background-color: var(--surface-color); border: 1px solid var(--surface-border-color); border-radius: 9999px; padding: 0.5rem 1rem; display: flex; gap: 0.75rem; align-items: center; z-index: 100; }
    </style>
</head>
<body>
    <div id="page-loader" class="fixed inset-0 bg-[#0f0f0f] flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-color"></div>
        <p id="page-loader-text" class="mt-4 text-xl">Iniciando...</p>
    </div>
    <div id="main-content" class="hidden flex-col h-full">
        <header class="bg-surface-color border-b border-surface-border-color py-3 px-4 sm:px-8 flex justify-between items-center sticky top-0 z-20 flex-shrink-0">
            <h2 id="project-title" class="text-lg sm:text-xl font-bold text-white truncate">Cargando...</h2>
            <div class="flex items-center gap-4">
                 <button id="fullscreen-btn" class="text-gray-400 hover:text-white"><i class="fas fa-expand text-xl"></i></button>
                 <button id="logout-btn" class="text-gray-400 hover:text-white"><i class="fas fa-sign-out-alt text-xl"></i></button>
            </div>
        </header>
        <main>
            <div id="pdf-viewer-container">
                <div id="pages-container"><div id="pdf-content"></div></div>
            </div>
        </main>
    </div>
    <div id="annotation-toolbar" class="hidden">
        <button class="tool-btn active" id="tool-select"><i class="fas fa-mouse-pointer"></i></button>
        <button class="tool-btn" id="tool-draw"><i class="fas fa-pencil-alt"></i></button>
        <button class="tool-btn" id="tool-highlight"><i class="fas fa-highlighter"></i></button>
        <button class="tool-btn" id="tool-erase"><i class="fas fa-eraser"></i></button>
    </div>
    <div id="page-number-indicator" class="fixed top-1/2 right-4 transform -translate-y-1/2 bg-black bg-opacity-70 text-white py-2 px-4 rounded-full z-50 opacity-0 pointer-events-none"></div>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        let currentUser, currentProjectId, currentPdfId, pdfDocument;
        let pagesHeight = [], currentPageNum = 1;
        let scrollTimeout;

        const DOM = {
            pageLoader: document.getElementById('page-loader'), mainContent: document.getElementById('main-content'), projectTitle: document.getElementById('project-title'), pdfContent: document.getElementById('pdf-content'), pagesContainer: document.getElementById('pages-container'), annotationToolbar: document.getElementById('annotation-toolbar'), pageIndicator: document.getElementById('page-number-indicator'), logoutBtn: document.getElementById('logout-btn'), fullscreenBtn: document.getElementById('fullscreen-btn'),
        };

        window.pdfjsLib.GlobalWorkerOptions.workerSrc = './pdf.worker.js';

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const urlParams = new URLSearchParams(window.location.search);
                currentProjectId = urlParams.get('id');
                currentPdfId = urlParams.get('docId');
                if (!currentProjectId || !currentPdfId) {
                    window.location.href = 'mi_tablero.html';
                    return;
                }
                initializeViewer();
            } else { window.location.href = 'index.html'; }
        });

        async function initializeViewer() {
            await loadAndRenderPDF(currentPdfId);
            addEventListeners();
            DOM.mainContent.classList.remove('hidden');
            DOM.pageLoader.classList.add('hidden');
        }

        async function loadAndRenderPDF(docId) {
            try {
                const pdfDocRef = doc(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs", docId);
                const pdfDocSnap = await getDoc(pdfDocRef);
                if (!pdfDocSnap.exists()) throw new Error("PDF no encontrado");
                
                DOM.projectTitle.textContent = pdfDocSnap.data().name;
                pdfDocument = await pdfjsLib.getDocument(pdfDocSnap.data().url).promise;
                DOM.pdfContent.innerHTML = '';
                pagesHeight = [0];
                
                for (let i = 1; i <= pdfDocument.numPages; i++) {
                    const page = await pdfDocument.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    const pageContainer = document.createElement('div');
                    pageContainer.className = 'pdf-page-container';
                    pageContainer.style.width = `${viewport.width}px`;
                    pageContainer.style.height = `${viewport.height}px`;
                    const canvas = document.createElement('canvas');
                    canvas.height = viewport.height; canvas.width = viewport.width;
                    const textLayerDiv = document.createElement('div');
                    textLayerDiv.className = 'textLayer';
                    const annotationCanvas = document.createElement('canvas');
                    annotationCanvas.className = 'annotation-canvas';
                    annotationCanvas.height = viewport.height; annotationCanvas.width = viewport.width;
                    pageContainer.append(canvas, textLayerDiv, annotationCanvas);
                    DOM.pdfContent.appendChild(pageContainer);
                    
                    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                    const textContent = await page.getTextContent();
                    await pdfjsLib.renderTextLayer({ textContentSource: textContent, container: textLayerDiv, viewport }).promise;
                }
                
                const pageElements = DOM.pdfContent.children;
                for (let i = 0; i < pageElements.length; i++) {
                    pagesHeight[i + 1] = (pagesHeight[i] || 0) + pageElements[i].offsetHeight + 16;
                }
                updatePageNumberIndicator();
                DOM.annotationToolbar.classList.remove('hidden');
            } catch (error) { console.error("Error cargando PDF:", error); }
        }

        function updatePageNumberIndicator() {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            if (!pdfDocument) return;
            DOM.pageIndicator.style.opacity = '1';
            const containerTop = DOM.pagesContainer.scrollTop;
            let newPageNum = 1;
            for (let i = 1; i < pagesHeight.length; i++) {
                if (containerTop > pagesHeight[i - 1] - (DOM.pagesContainer.clientHeight / 2)) newPageNum = i;
                else break;
            }
            currentPageNum = newPageNum;
            DOM.pageIndicator.textContent = `PÃ¡gina ${currentPageNum} / ${pdfDocument.numPages}`;
            scrollTimeout = setTimeout(() => { DOM.pageIndicator.style.opacity = '0'; }, 1500);
        }

        function addEventListeners() {
            DOM.logoutBtn.addEventListener('click', () => signOut(auth));
            DOM.fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                else document.exitFullscreen();
            });
            DOM.pagesContainer.addEventListener('scroll', updatePageNumberIndicator);
        }
    </script>
</body>
</html>
