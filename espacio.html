<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Espacio de Trabajo - Papiro Digital</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js`;</script>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <a href="mi_tablero.html" class="logo">← Volver a Mis Tableros</a>
        <h2 id="project-title" style="margin: 0;"></h2>
        <div>
            <span id="user-info"></span>
            <button id="logout-btn" class="btn btn-danger">Cerrar Sesión</button>
        </div>
    </nav>
    
    <div class="workspace-grid container">
        <div class="content-list">
            <h3>Contenido</h3>
            <div id="content-items"></div>
            <hr>
            <h4>Añadir PDF</h4>
            <input type="file" id="pdf-upload" accept="application/pdf">
            <button id="upload-btn" class="btn">Subir</button>
        </div>
        <div class="pdf-viewer" id="viewer-container">
             <canvas id="pdf-canvas"></canvas>
        </div>
        <div class="notes-area">
            <h3>Notas del Tema</h3>
            <textarea style="width: 100%; height: 200px;" placeholder="Tus notas aquí..."></textarea>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        const projectTitle = document.getElementById('project-title');
        const contentItems = document.getElementById('content-items');
        const pdfCanvas = document.getElementById('pdf-canvas');
        const uploadBtn = document.getElementById('upload-btn');
        const pdfUploadInput = document.getElementById('pdf-upload');
        const ctx = pdfCanvas.getContext('2d');
        let currentUser, projectId;

        // Obtener projectId de la URL
        const params = new URLSearchParams(window.location.search);
        projectId = params.get('projectId');
        
        auth.onAuthStateChanged(user => {
            if (user && projectId) {
                currentUser = user;
                loadProjectData();
                loadContent();
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadProjectData() {
            const projectRef = db.collection('users').doc(currentUser.uid).collection('projects').doc(projectId);
            const doc = await projectRef.get();
            if (doc.exists) {
                projectTitle.textContent = doc.data().name;
            } else {
                projectTitle.textContent = "Proyecto no encontrado";
            }
        }

        function loadContent() {
            const contentRef = db.collection('users').doc(currentUser.uid).collection('projects').doc(projectId).collection('content');
            contentRef.where('type', '==', 'pdf').onSnapshot(snapshot => {
                contentItems.innerHTML = '<h4>PDFs</h4>';
                let firstPdfUrl = null;
                snapshot.forEach(doc => {
                    const content = doc.data();
                    const item = document.createElement('p');
                    item.textContent = content.title;
                    item.style.cursor = 'pointer';
                    item.onclick = () => renderPdf(content.url);
                    contentItems.appendChild(item);
                    if (!firstPdfUrl) {
                        firstPdfUrl = content.url;
                    }
                });
                // Cargar el primer PDF de la lista automáticamente
                if (firstPdfUrl) {
                    renderPdf(firstPdfUrl);
                } else {
                    contentItems.innerHTML += '<p>No hay PDFs en este tablero.</p>';
                }
            });
        }

        async function renderPdf(pdfUrl) {
            try {
                const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
                const page = await pdf.getPage(1); // Cargar la primera página
                const viewport = page.getViewport({ scale: 1.5 });
                
                pdfCanvas.height = viewport.height;
                pdfCanvas.width = viewport.width;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                page.render(renderContext);
            } catch (error) {
                console.error('Error al renderizar el PDF:', error);
                alert("No se pudo cargar el PDF. Revisa la consola para más detalles.");
            }
        }
        
        uploadBtn.addEventListener('click', async () => {
            const file = pdfUploadInput.files[0];
            if (!file) {
                alert("Por favor, selecciona un archivo PDF.");
                return;
            }

            const filePath = `users/${currentUser.uid}/${projectId}/${file.name}`;
            const fileRef = storage.ref(filePath);
            
            try {
                await fileRef.put(file);
                const url = await fileRef.getDownloadURL();

                // Guardar la referencia en Firestore
                await db.collection('users').doc(currentUser.uid).collection('projects').doc(projectId).collection('content').add({
                    title: file.name,
                    type: 'pdf',
                    storagePath: filePath,
                    url: url,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert("PDF subido con éxito!");
                pdfUploadInput.value = ''; // Limpiar input
            } catch (error) {
                console.error("Error al subir archivo: ", error);
                alert("Hubo un error al subir el archivo.");
            }
        });

    </script>
</body>
</html>
