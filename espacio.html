<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Papiro Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --background-color: #0f0f0f; --surface-color: #181818; --surface-border-color: #2a2a2a; --primary-color: #88c999; --text-color: #ffffff; --text-muted-color: #9ca3af; }
        .hidden { display: none !important; }
        html { height: 100%; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-color); color: white; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #grid-view-container, #pdf-viewer-container { padding: 1.5rem; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        #pdf-viewer-container { padding: 0.5rem; }
        .pdf-page-container { position: relative; margin: 0 auto 1rem auto; max-width: 100%; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .pdf-page-container canvas, .textLayer { width: 100% !important; height: auto !important; display: block; }
        .annotation-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; touch-action: none; }
        #annotation-toolbar { position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); background-color: var(--surface-color); border: 1px solid var(--surface-border-color); border-radius: 9999px; padding: 0.5rem 1rem; display: flex; gap: 0.75rem; align-items: center; z-index: 100; }
        #sidebar { position: fixed; top: 0; right: -100%; width: 100%; max-width: 350px; height: 100%; background-color: var(--surface-color); transition: right 0.3s ease-in-out; z-index: 110; padding: 1.5rem; display: flex; flex-direction: column; }
        #sidebar.open { right: 0; }
    </style>
</head>
<body>
    <div id="page-loader" class="fixed inset-0 bg-[#0f0f0f] flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-color"></div>
        <p id="page-loader-text" class="mt-4 text-xl">Iniciando...</p>
    </div>
    <div id="main-content" class="hidden flex-col h-full">
        <header class="bg-surface-color border-b border-surface-border-color py-3 px-4 sm:px-8 flex justify-between items-center sticky top-0 z-20 flex-shrink-0">
            <div class="flex items-center gap-4 flex-1 min-w-0">
                <button id="dynamic-back-btn" class="flex-shrink-0"><i class="fas fa-arrow-left text-xl"></i></button>
                <h2 id="project-title" class="text-lg sm:text-xl font-bold text-white truncate">Cargando...</h2>
            </div>
            <button id="logout-btn" class="text-gray-400 hover:text-white transition"><i class="fas fa-sign-out-alt text-xl"></i></button>
        </header>
        <main class="flex-grow flex flex-col overflow-hidden">
            <div id="grid-view-container" class="w-full max-w-5xl mx-auto hidden">
                <div id="pdfs-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
            </div>
            <div id="pdf-viewer-container" class="relative w-full hidden">
                <div id="pages-container" class="flex-grow w-full h-full"><div id="pdf-content" class="w-full"></div></div>
            </div>
        </main>
    </div>
    
    <div id="annotation-toolbar" class="hidden">
        <button class="tool-btn active" id="tool-select"><i class="fas fa-mouse-pointer"></i></button>
        <button class="tool-btn" id="tool-draw"><i class="fas fa-pencil-alt"></i></button>
        <button class="tool-btn" id="tool-highlight"><i class="fas fa-highlighter"></i></button>
        <button class="tool-btn" id="tool-erase"><i class="fas fa-eraser"></i></button>
        <button id="open-sidebar-btn" class="tool-btn"><i class="fas fa-book"></i></button>
    </div>
    <div id="page-number-indicator" class="fixed top-1/2 right-4 transform -translate-y-1/2 bg-black bg-opacity-70 text-white py-2 px-4 rounded-full z-50 opacity-0 pointer-events-none"></div>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { collection, query, doc, onSnapshot, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        let currentUser, currentProjectId, currentPdfId, pdfDocument;
        let pagesHeight = [], currentPageNum = 1;
        let scrollTimeout;

        const DOM = {
            pageLoader: document.getElementById('page-loader'),
            mainContent: document.getElementById('main-content'),
            projectTitle: document.getElementById('project-title'),
            gridView: document.getElementById('grid-view-container'),
            pdfViewer: document.getElementById('pdf-viewer-container'),
            pdfsGrid: document.getElementById('pdfs-grid'),
            pagesContainer: document.getElementById('pages-container'),
            pdfContent: document.getElementById('pdf-content'),
            pageIndicator: document.getElementById('page-number-indicator'),
            dynamicBackBtn: document.getElementById('dynamic-back-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            annotationToolbar: document.getElementById('annotation-toolbar'),
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const urlParams = new URLSearchParams(window.location.search);
                currentProjectId = urlParams.get('id');
                currentPdfId = urlParams.get('docId');
                if (!currentProjectId) { window.location.href = 'mi_tablero.html'; return; }
                initializePage();
            } else { window.location.href = 'index.html'; }
        });

        async function initializePage() {
            await loadProjectDetails();
            addEventListeners();
            if (currentPdfId) { await showView('viewer'); } 
            else { await showView('grid'); }
            DOM.mainContent.classList.remove('hidden');
            DOM.pageLoader.classList.add('hidden');
        }

        async function showView(viewName) {
            DOM.gridView.classList.toggle('hidden', viewName !== 'grid');
            DOM.pdfViewer.classList.toggle('hidden', viewName !== 'viewer');
            if (viewName === 'viewer') {
                DOM.pdfViewer.classList.add('flex', 'flex-col');
                DOM.annotationToolbar.classList.remove('hidden');
                await loadAndRenderPDF(currentPdfId);
            } else {
                DOM.gridView.classList.add('flex', 'flex-col');
                loadPdfsForProject();
            }
        }

        async function loadProjectDetails() {
            const projectRef = doc(db, "users", currentUser.uid, "projects", currentProjectId);
            const projectSnap = await getDoc(projectRef);
            if (projectSnap.exists()) DOM.projectTitle.textContent = projectSnap.data().name;
        }

        function loadPdfsForProject() {
            const q = query(collection(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs"));
            onSnapshot(q, (snapshot) => {
                DOM.pdfsGrid.innerHTML = '';
                snapshot.forEach(pdfDoc => {
                    const pdfData = pdfDoc.data();
                    const card = document.createElement('a');
                    card.href = `espacio.html?id=${currentProjectId}&docId=${pdfDoc.id}`;
                    card.className = 'pdf-card rounded-lg shadow-lg cursor-pointer flex flex-col aspect-[2/3] bg-surface-color border border-surface-border-color';
                    card.innerHTML = `<div class="flex-grow w-full rounded-t-lg flex items-center justify-center p-2"><i class="fas fa-file-pdf text-4xl text-gray-500"></i></div><div class="p-2 h-1/4 flex items-center justify-center"><p class="w-full text-center text-sm font-semibold truncate">${pdfData.name || 'Documento'}</p></div>`;
                    DOM.pdfsGrid.appendChild(card);
                });
            }, (error) => {
                console.error("Error cargando PDFs:", error);
            });
        }
        
        async function loadAndRenderPDF(docId) {
            try {
                const pdfDocRef = doc(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs", docId);
                const pdfDocSnap = await getDoc(pdfDocRef);
                if (!pdfDocSnap.exists()) throw new Error("PDF no encontrado");
                
                pdfDocument = await pdfjsLib.getDocument(pdfDocSnap.data().url).promise;
                DOM.pdfContent.innerHTML = '';
                pagesHeight = [0];

                for (let i = 1; i <= pdfDocument.numPages; i++) {
                    const page = await pdfDocument.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    const pageContainer = document.createElement('div');
                    pageContainer.className = 'pdf-page-container';
                    pageContainer.style.width = `${viewport.width}px`;
                    pageContainer.style.height = `${viewport.height}px`;
                    
                    const canvas = document.createElement('canvas');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    pageContainer.appendChild(canvas);
                    DOM.pdfContent.appendChild(pageContainer);
                    
                    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                }
                
                const pageElements = DOM.pdfContent.children;
                for (let i = 0; i < pageElements.length; i++) {
                    pagesHeight[i + 1] = (pagesHeight[i] || 0) + pageElements[i].offsetHeight + 16;
                }
                updatePageNumberIndicator();
            } catch (error) {
                console.error("Error cargando PDF:", error);
            }
        }

        function updatePageNumberIndicator() {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            if (!pdfDocument) return;
            DOM.pageIndicator.style.opacity = '1';
            const containerTop = DOM.pagesContainer.scrollTop;
            let newPageNum = 1;
            for (let i = 1; i < pagesHeight.length; i++) {
                if (containerTop > pagesHeight[i - 1] - (DOM.pagesContainer.clientHeight / 2)) {
                    newPageNum = i;
                } else { break; }
            }
            if (currentPageNum !== newPageNum) currentPageNum = newPageNum;
            DOM.pageIndicator.textContent = `Página ${currentPageNum} / ${pdfDocument.numPages}`;
            scrollTimeout = setTimeout(() => { DOM.pageIndicator.style.opacity = '0'; }, 1500);
        }

        function addEventListeners() {
            DOM.dynamicBackBtn.addEventListener('click', () => {
                if (currentPdfId) {
                    window.location.href = `espacio.html?id=${currentProjectId}`;
                } else {
                    window.location.href = 'mi_tablero.html';
                }
            });
            DOM.logoutBtn.addEventListener('click', () => signOut(auth));
            DOM.pagesContainer.addEventListener('scroll', updatePageNumberIndicator);
        }
    </script>
</body>
</html>
