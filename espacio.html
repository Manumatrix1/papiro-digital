<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Cargando...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f0f0f; }
        #pages-container .pdf-page-container {
            position: relative; /* Clave para que los overlays se posicionen correctamente */
        }
        .annotation-overlay {
            position: absolute;
            opacity: 0.4;
            border-radius: 2px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .annotation-overlay:hover {
            opacity: 0.6;
        }
        #sidebar {
            right: -100%;
            transition: right 0.3s ease-in-out;
        }
        #sidebar.open {
            right: 0;
        }
        /* Estilos adicionales del original para mantener la consistencia */
        .pdf-list-item { transition: transform 0.2s ease-in-out; aspect-ratio: 1 / 1; position: relative; background-size: cover; background-position: center; }
        .pdf-list-item:hover { transform: translateY(-5px); }
        #pdf-render { box-shadow: 0 4px 15px rgba(0,0,0,0.5); max-width: 100%; height: auto; }
        #cover-container { width: 100%; height: 150px; background-color: #2a2a2a; position: relative; overflow: hidden; border-radius: 8px; background-size: cover; background-position: center; }
        @media (min-width: 640px) { #cover-container { height: 250px; } }
        .pdf-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1.5rem; }
        #page-number-indicator { position: fixed; top: 50%; right: 1rem; transform: translateY(-50%); background-color: rgba(0,0,0,0.7); color: white; padding: 0.5rem 1rem; border-radius: 9999px; font-weight: bold; display: none; z-index: 50; transition: opacity 0.2s ease-in-out; }
    </style>
</head>
<body class="text-white flex flex-col min-h-screen">
    <header class="bg-[#181818] border-b border-[#2a2a2a] py-3 px-4 sm:px-8 flex justify-between items-center sticky top-0 z-40">
        <div class="flex items-center gap-4">
            <button id="dynamic-back-btn" class="flex items-center text-gray-400 hover:text-white transition group">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                <span id="dynamic-back-text" class="ml-2 font-medium hidden sm:inline">Mis Tableros</span>
            </button>
            <h1 id="project-title-display" class="text-xl sm:text-2xl font-bold text-white truncate">Cargando...</h1>
        </div>
        <div class="flex items-center gap-2 sm:gap-4">
             <button id="open-sidebar-btn" class="bg-gray-700 text-white rounded-lg w-10 h-10 flex items-center justify-center shadow-lg hover:bg-gray-600 transition">
                <i class="fas fa-book"></i>
            </button>
            <button id="logout-btn" class="text-gray-400 hover:text-white transition text-sm sm:text-base">Cerrar Sesión</button>
        </div>
    </header>

    <main class="flex-1 flex flex-col items-center overflow-auto p-4 sm:p-8" id="main-content">
        <div id="grid-view-container" class="w-full max-w-5xl">
             <div id="pdfs-section" class="w-full mt-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="pdfs-title" class="text-2xl font-bold">Mis Documentos</h2>
                </div>
                <div id="pdf-list" class="pdf-grid">
                    <div class="pdf-list-item flex flex-col items-center justify-center bg-[#181818] rounded-lg p-6 shadow-lg border border-dashed border-gray-600 transition hover:bg-[#2a2a2a] cursor-pointer" id="visual-upload-btn" style="aspect-ratio: 1 / 1;">
                        <svg class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        <span class="mt-4 font-semibold text-gray-400 text-sm">Nuevo PDF</span>
                    </div>
                </div>
                <input type="file" id="pdf-file-input" class="hidden" accept="application/pdf">
            </div>
        </div>

        <div id="pdf-viewer-container" class="mt-4 sm:mt-8 relative w-full max-w-4xl" style="display: none;">
            <div id="pages-container" class="w-full h-full overflow-y-auto space-y-4">
                </div>
        </div>
    </main>

    <aside id="sidebar" class="bg-[#181818] text-white fixed top-0 w-full max-w-sm h-full transform translate-x-full transition-transform duration-300 z-50 p-4 flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Cuaderno de Anotaciones</h3>
            <button id="close-sidebar-btn" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="mb-4">
            <label class="text-sm font-semibold text-gray-400">Color de Resaltado</label>
            <div id="highlight-tools" class="flex gap-3 mt-2">
                <button class="w-8 h-8 rounded-full border-2 border-transparent focus:border-white" style="background-color: rgba(250, 204, 21, 0.4);" data-color="#facc15" data-rgba="rgba(250, 204, 21, 0.4)"></button>
                <button class="w-8 h-8 rounded-full border-2 border-transparent focus:border-white" style="background-color: rgba(59, 130, 246, 0.4);" data-color="#3b82f6" data-rgba="rgba(59, 130, 246, 0.4)"></button>
                <button class="w-8 h-8 rounded-full border-2 border-transparent focus:border-white" style="background-color: rgba(239, 68, 68, 0.4);" data-color="#ef4444" data-rgba="rgba(239, 68, 68, 0.4)"></button>
                <button class="w-8 h-8 rounded-full border-2 border-transparent focus:border-white" style="background-color: rgba(34, 197, 94, 0.4);" data-color="#22c55e" data-rgba="rgba(34, 197, 94, 0.4)"></button>
            </div>
        </div>

        <div class="flex gap-2 mb-4">
            <input type="text" id="search-notes-input" placeholder="Buscar en notas..." class="w-full bg-[#2a2a2a] text-white placeholder-gray-400 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#88c999]">
            <button id="summarize-btn" title="Resumir Notas por Página" class="bg-blue-600 text-white px-3 rounded-lg hover:bg-blue-500 transition"><i class="fas fa-list-ul"></i></button>
        </div>

        <div id="notes-list" class="space-y-3 overflow-y-auto flex-1">
            <p id="no-notes-message" class="text-gray-500 text-center mt-8">Selecciona texto en el PDF para crear una anotación.</p>
        </div>
    </aside>
    
    <div id="page-number-indicator"></div>
    <div id="pdf-loader-container" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50" style="display: none;">
        <div class="text-center"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-[#88c999]"></div><p id="pdf-loader-text" class="mt-4 text-xl">Cargando...</p></div>
    </div>
    
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBYVYRdA_DB1Kob9b_wGd5Wd4JsYFMyBRc",
            authDomain: "papiro2025-d09e0.firebaseapp.com",
            projectId: "papiro2025-d09e0",
            storageBucket: "papiro2025-d09e0.appspot.com", // Corregido el dominio
            messagingSenderId: "1096335704864",
            appId: "1:1096335704864:web:75f1f27cd920df64554d45",
            measurementId: "G-03Y1260F1S"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // Variables globales del estado de la aplicación
        let currentUser = null;
        let currentProjectId = null;
        let currentPdfId = null;
        let pdfDocument = null; 
        let unsubscribeHighlights = null;

        // Variables para la funcionalidad de resaltado
        let highlightColor = '#facc15'; 
        let highlightRgba = 'rgba(250, 204, 21, 0.4)';

        // Elementos del DOM
        const projectTitleDisplay = document.getElementById('project-title-display');
        const pdfLoaderContainer = document.getElementById('pdf-loader-container');
        const pdfLoaderText = document.getElementById('pdf-loader-text');
        const gridViewContainer = document.getElementById('grid-view-container');
        const pdfViewerContainer = document.getElementById('pdf-viewer-container');
        const pagesContainer = document.getElementById('pages-container');
        const dynamicBackBtn = document.getElementById('dynamic-back-btn');
        const pdfList = document.getElementById('pdf-list');
        const pdfFileInput = document.getElementById('pdf-file-input');
        
        // Elementos del Cuaderno (Sidebar)
        const sidebar = document.getElementById('sidebar');
        const openSidebarBtn = document.getElementById('open-sidebar-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const highlightTools = document.getElementById('highlight-tools');
        const notesList = document.getElementById('notes-list');
        const noNotesMessage = document.getElementById('no-notes-message');
        const searchNotesInput = document.getElementById('search-notes-input');
        const summarizeBtn = document.getElementById('summarize-btn');
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // --- INICIALIZACIÓN Y AUTENTICACIÓN ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = user;
            const urlParams = new URLSearchParams(window.location.search);
            currentProjectId = urlParams.get('id');
            const docId = urlParams.get('docId');

            if (!currentProjectId) {
                window.location.href = 'mi_tablero.html';
                return;
            }

            // Cargar datos del proyecto
            const projectRef = doc(db, "users", currentUser.uid, "projects", currentProjectId);
            const projectDoc = await getDoc(projectRef);
            if (projectDoc.exists()) {
                projectTitleDisplay.textContent = projectDoc.data().name;
            }

            if (docId) {
                currentPdfId = docId;
                await loadPDFViewer(currentPdfId);
                sidebar.classList.add('open'); // Abrir cuaderno al cargar un PDF
            } else {
                loadPdfGrid();
            }
        });

        // --- VISTA DE GRILLA DE PDFs ---
        function loadPdfGrid() {
            gridViewContainer.style.display = 'block';
            pdfViewerContainer.style.display = 'none';
            const pdfsQuery = query(collection(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs"));
            onSnapshot(pdfsQuery, (snapshot) => {
                const existingCards = pdfList.querySelectorAll('.pdf-list-item:not(#visual-upload-btn)');
                existingCards.forEach(card => card.remove());
                snapshot.forEach(createPdfCard);
            });
            document.getElementById('visual-upload-btn').addEventListener('click', () => pdfFileInput.click());
        }
        
        function createPdfCard(pdfDoc) {
            const pdfData = pdfDoc.data();
            const card = document.createElement('div');
            card.className = 'pdf-list-item bg-[#181818] rounded-lg p-4 flex flex-col justify-between shadow-lg border border-[#2a2a2a] transition cursor-pointer';
            card.innerHTML = `<h3 class="font-bold text-white truncate">${pdfData.name}</h3> <p class="text-sm text-gray-400 truncate">${pdfData.fileName}</p>`;
            card.addEventListener('click', () => {
                window.location.search = `?id=${currentProjectId}&docId=${pdfDoc.id}`;
            });
            pdfList.insertBefore(card, document.getElementById('visual-upload-btn'));
        }

        pdfFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || file.type !== 'application/pdf') return;

            showLoader("Subiendo PDF...");
            const pdfsCollectionRef = collection(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs");
            const newPdfDocRef = doc(pdfsCollectionRef);
            const storageRef = ref(storage, `proyectos/${currentUser.uid}/${currentProjectId}/pdfs/${newPdfDocRef.id}-${file.name}`);
            const uploadTask = uploadBytesResumable(storageRef, file);

            uploadTask.on('state_changed', 
                (s) => pdfLoaderText.textContent = `Subiendo: ${Math.round((s.bytesTransferred / s.totalBytes) * 100)}%`,
                (err) => { hideLoader(); console.error(err); },
                async () => {
                    const url = await getDownloadURL(uploadTask.snapshot.ref);
                    await setDoc(newPdfDocRef, {
                        name: file.name.replace('.pdf', ''),
                        fileName: file.name,
                        url: url,
                        createdAt: new Date()
                    });
                    hideLoader();
                }
            );
        });

        // --- VISOR DE PDF Y LÓGICA DEL CUADERNO ---
        async function loadPDFViewer(pdfId) {
            showLoader("Cargando PDF...");
            gridViewContainer.style.display = 'none';
            pdfViewerContainer.style.display = 'block';

            const pdfDocRef = doc(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs", pdfId);
            const pdfDocSnap = await getDoc(pdfDocRef);
            if (!pdfDocSnap.exists()) {
                console.error("PDF no encontrado");
                hideLoader();
                return;
            }
            projectTitleDisplay.textContent = pdfDocSnap.data().name;

            const loadingTask = pdfjsLib.getDocument(pdfDocSnap.data().url);
            pdfDocument = await loadingTask.promise;
            pagesContainer.innerHTML = '';
            
            for (let i = 1; i <= pdfDocument.numPages; i++) {
                const page = await pdfDocument.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });
                const pageDiv = document.createElement('div');
                pageDiv.className = 'pdf-page-container';
                pageDiv.dataset.pageNumber = i;
                const canvas = document.createElement('canvas');
                canvas.className = 'w-full h-auto shadow-lg';
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                pageDiv.appendChild(canvas);
                pagesContainer.appendChild(pageDiv);
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
            }
            
            // Adjuntar listener para crear anotaciones
            pagesContainer.addEventListener('mouseup', handleTextSelection);

            // Cargar y dibujar anotaciones existentes
            loadAndDrawAnnotations();
            hideLoader();
        }

        // --- FUNCIONALIDAD DE ANOTACIONES (EXPERTS 2, 4, 5) ---
        async function handleTextSelection(e) {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            if (!selectedText || !currentPdfId) return;

            const range = selection.getRangeAt(0);
            const pageElement = range.startContainer.parentElement.closest('.pdf-page-container');
            if (!pageElement) return;

            const pageNum = parseInt(pageElement.dataset.pageNumber);
            const pageRect = pageElement.getBoundingClientRect();
            const selectionRects = Array.from(range.getClientRects()).map(rect => ({
                top: rect.top - pageRect.top,
                left: rect.left - pageRect.left,
                width: rect.width,
                height: rect.height
            }));

            selection.removeAllRanges();

            const { value: result } = await Swal.fire({
                title: 'Añadir Anotación',
                html: `<textarea id="swal-note" class="swal2-textarea" placeholder="Escribe tu nota aquí..." style="min-height: 100px;"></textarea>
                       <input id="swal-tags" class="swal2-input" placeholder="Etiquetas (ej: importante, examen)">`,
                focusConfirm: false,
                confirmButtonText: 'Guardar',
                showCancelButton: true,
                cancelButtonText: 'Cancelar',
                background: '#181818',
                color: '#fff',
                preConfirm: () => ({
                    note: document.getElementById('swal-note').value,
                    tags: document.getElementById('swal-tags').value.split(',').map(t => t.trim()).filter(Boolean)
                })
            });

            if (result) {
                const highlightsRef = collection(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs", currentPdfId, "highlights");
                await addDoc(highlightsRef, {
                    text: selectedText,
                    note: result.note,
                    tags: result.tags,
                    page: pageNum,
                    rectangles: selectionRects,
                    color: highlightColor,
                    rgba: highlightRgba,
                    createdAt: new Date()
                });
            }
        }
        
        function loadAndDrawAnnotations() {
            if (unsubscribeHighlights) unsubscribeHighlights(); // Detener listener anterior
            
            const highlightsQuery = query(collection(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs", currentPdfId, "highlights"));
            
            unsubscribeHighlights = onSnapshot(highlightsQuery, (snapshot) => {
                // Limpiar overlays y lista de notas anteriores
                document.querySelectorAll('.annotation-overlay').forEach(el => el.remove());
                notesList.innerHTML = '';
                
                if (snapshot.empty) {
                    noNotesMessage.style.display = 'block';
                    return;
                }
                
                noNotesMessage.style.display = 'none';
                snapshot.docs.sort((a, b) => a.data().page - b.data().page).forEach(doc => {
                    const data = doc.data();
                    drawAnnotation(data);
                    createNoteCard(data, doc.id);
                });
            });
        }

        function drawAnnotation(data) {
            const pageDiv = pagesContainer.querySelector(`[data-page-number="${data.page}"]`);
            if (!pageDiv) return;

            data.rectangles.forEach(rect => {
                const overlay = document.createElement('div');
                overlay.className = 'annotation-overlay';
                overlay.style.backgroundColor = data.rgba;
                overlay.style.left = `${rect.left}px`;
                overlay.style.top = `${rect.top}px`;
                overlay.style.width = `${rect.width}px`;
                overlay.style.height = `${rect.height}px`;
                pageDiv.appendChild(overlay);
            });
        }
        
        function createNoteCard(data, docId) {
            const card = document.createElement('div');
            card.className = 'note-card bg-[#2a2a2a] p-3 rounded-lg';
            card.dataset.text = `${data.text} ${data.note} ${data.tags.join(' ')}`.toLowerCase();
            card.style.borderLeft = `4px solid ${data.color}`;

            card.innerHTML = `
                <p class="text-xs text-gray-400 mb-1">Página ${data.page}</p>
                <p class="font-semibold text-sm text-white line-clamp-2">"${data.text}"</p>
                <p class="text-sm text-gray-300 mt-1">${data.note || '<i>Sin nota adicional</i>'}</p>
                <div class="mt-2 flex flex-wrap gap-1">
                    ${data.tags.map(tag => `<span class="bg-gray-500 text-white text-xs font-bold px-2 py-1 rounded-full">${tag}</span>`).join('')}
                </div>
            `;
            notesList.appendChild(card);
        }

        // --- CONTROLES Y EVENTOS DE LA UI ---
        
        // Manejo del Cuaderno (Sidebar)
        openSidebarBtn.addEventListener('click', () => sidebar.classList.add('open'));
        closeSidebarBtn.addEventListener('click', () => sidebar.classList.remove('open'));
        
        // Paleta de colores (Expert 3)
        highlightTools.addEventListener('click', (e) => {
            if (e.target.dataset.color) {
                highlightColor = e.target.dataset.color;
                highlightRgba = e.target.dataset.rgba;
                // Opcional: añadir feedback visual al color seleccionado
                highlightTools.querySelectorAll('button').forEach(btn => btn.style.borderColor = 'transparent');
                e.target.style.borderColor = 'white';
            }
        });
        
        // Búsqueda de notas (Expert 6)
        searchNotesInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            notesList.querySelectorAll('.note-card').forEach(card => {
                card.style.display = card.dataset.text.includes(term) ? 'block' : 'none';
            });
        });

        // Resumir notas (Expert 7)
        summarizeBtn.addEventListener('click', () => {
            const summary = {};
            notesList.querySelectorAll('.note-card').forEach(card => {
                const pageText = card.querySelector('p').textContent; // "Página X"
                const pageNum = pageText.split(' ')[1];
                summary[pageNum] = (summary[pageNum] || 0) + 1;
            });
            const summaryText = Object.entries(summary)
                .map(([page, count]) => `Página ${page}: ${count} nota(s)`)
                .join('<br>');
            
            Swal.fire({
                title: 'Resumen de Anotaciones',
                html: summaryText || 'No hay notas para resumir.',
                icon: 'info',
                background: '#181818',
                color: '#fff'
            });
        });

        // Botón de Volver
        dynamicBackBtn.addEventListener('click', () => {
            window.location.search = `?id=${currentProjectId}`;
        });

        // Botón de Cerrar Sesión
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
        });

        // Helpers
        function showLoader(message) {
            pdfLoaderText.textContent = message;
            pdfLoaderContainer.style.display = 'flex';
        }
        function hideLoader() {
            pdfLoaderContainer.style.display = 'none';
        }

    </script>
</body>
</html>
