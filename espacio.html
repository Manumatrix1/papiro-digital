<!DOCTYPE html>
<html lang="es">
<head>
    <style>
        /* ... (El style no cambia, pero asegúrate de tener estas clases) ... */
        #add-note-popup {
            display: none; /* Se mostrará con JS */
            position: absolute;
            background-color: var(--surface-color);
            border: 1px solid var(--surface-border-color);
            border-radius: 8px;
            padding: 0.5rem;
            z-index: 101;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            display: flex; /* Usamos flex para la paleta */
            gap: 0.5rem;
        }
        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }
        .color-swatch:hover {
            transform: scale(1.2);
            border-color: #fff;
        }
    </style>
</head>
<body>
    <div id="add-note-popup">
        <div class="color-swatch" style="background-color: #fde047;" data-color="#fde047"></div> <div class="color-swatch" style="background-color: #a7f3d0;" data-color="#a7f3d0"></div> <div class="color-swatch" style="background-color: #bfdbfe;" data-color="#bfdbfe"></div> <div class="color-swatch" style="background-color: #fecaca;" data-color="#fecaca"></div> </div>
    
    <script type="module">
        // ... (Imports de Firebase y configuración no cambian) ...

        // ... (Declaración de variables globales y DOM no cambia) ...

        // --- INICIO Y LÓGICA PRINCIPAL ---
        onAuthStateChanged(auth, (user) => {
            if (user) { /* ... La lógica de autenticación no cambia ... */ }
        });
        
        // ... (initializePage, showView, loadProjectDetails, loadPdfsForProject no cambian) ...

        // --- FUNCIONES COMPLETAS DEL VISOR (CONTEO Y BANDERITAS) ---
        
        async function loadAndRenderPDF(docId) {
            // ... (Esta función ahora está completa y correcta, como en la versión anterior) ...
        }

        function createHighlightAnnotation(pageNum, rects, color) {
            const annotationData = { type: 'textHighlight', rects: [], color, page: pageNum };
            const annotationCanvas = document.querySelector(`.annotation-canvas[data-page-num="${pageNum}"]`);
            const scale = annotationCanvas.getBoundingClientRect().width / annotationCanvas.width;
            
            for (const rect of rects) {
                const canvasRect = {
                    x: (rect.left - annotationCanvas.getBoundingClientRect().left) / scale,
                    y: (rect.top - annotationCanvas.getBoundingClientRect().top) / scale,
                    width: rect.width / scale,
                    height: rect.height / scale,
                };
                annotationData.rects.push(canvasRect);
            }
            saveAnnotationToFirestore(pageNum, annotationData);
        }

        function drawAnnotationsForPage(pageNum) {
            const canvas = document.querySelector(`.annotation-canvas[data-page-num="${pageNum}"]`);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            (annotationsByPage[pageNum] || []).forEach(ann => {
                if ((ann.type === 'draw' || ann.type === 'highlight') && ann.path?.length > 1) {
                    // ... Dibuja trazos de lápiz y resaltador ...
                } else if (ann.type === 'textHighlight' && ann.rects?.length > 0) {
                    ctx.fillStyle = ann.color;
                    ctx.globalAlpha = 0.4;
                    ann.rects.forEach(rect => {
                        ctx.fillRect(rect.x, rect.y, rect.width, rect.height);
                    });
                    ctx.globalAlpha = 1.0;
                }
            });
        }

        async function handleNewNote(options = {}) {
            const { selection, color } = options;
            // Si hay selección, crea la nota directamente sin preguntar.
            if (selection) {
                await addDoc(collection(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs", currentPdfId, "notes"), {
                    text: "Cita resaltada",
                    selection,
                    color,
                    page: currentPageNum,
                    createdAt: new Date(),
                });
                return;
            }
            // Si es una nota general, pregunta al usuario.
            const { value: text } = await Swal.fire({ title: 'Añadir Nota General', input: 'textarea', /* ... */ });
            if (text) { /* ... guarda la nota general ... */ }
        }
        
        function updatePageNumberIndicator() {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            if (!pdfDocument) return;
            DOM.pageIndicator.style.opacity = '1';
            const containerTop = DOM.pagesContainer.scrollTop;
            let newPageNum = 1;
            for (let i = 1; i < pagesHeight.length; i++) {
                if (containerTop > pagesHeight[i - 1] - (DOM.pagesContainer.clientHeight / 2)) {
                    newPageNum = i;
                } else { break; }
            }
            if (currentPageNum !== newPageNum) currentPageNum = newPageNum;
            DOM.pageIndicator.textContent = `Página ${currentPageNum} / ${pdfDocument.numPages}`;
            scrollTimeout = setTimeout(() => { DOM.pageIndicator.style.opacity = '0'; }, 1500);
        }
        
        // --- MANEJADORES DE EVENTOS ---
        function addEventListeners() {
            // ... (listeners de back, logout, sidebar, etc. no cambian) ...

            // Evento para mostrar la paleta de colores al seleccionar texto
            DOM.pdfContent.addEventListener('mouseup', () => {
                const selection = window.getSelection();
                selectedTextForNote = selection.toString().trim();
                if (selectedTextForNote) {
                    const range = selection.getRangeAt(0);
                    const rect = range.getBoundingClientRect();
                    const containerRect = DOM.pdfContent.getBoundingClientRect();
                    DOM.addNotePopup.style.left = `${rect.left - containerRect.left + rect.width / 2 - DOM.addNotePopup.offsetWidth / 2}px`;
                    DOM.addNotePopup.style.top = `${rect.top - containerRect.top - DOM.addNotePopup.offsetHeight - 5}px`;
                    DOM.addNotePopup.style.display = 'flex';
                } else {
                    DOM.addNotePopup.style.display = 'none';
                }
            });

            // Evento para la paleta de colores (las banderitas)
            DOM.addNotePopup.addEventListener('click', (e) => {
                if (e.target.classList.contains('color-swatch')) {
                    const color = e.target.dataset.color;
                    const selection = window.getSelection();
                    const range = selection.getRangeAt(0);
                    const pageElement = range.startContainer.parentElement.closest('.pdf-page-container');
                    const pageNum = parseInt(pageElement.querySelector('.annotation-canvas').dataset.pageNum);
                    
                    createHighlightAnnotation(pageNum, range.getClientRects(), color);
                    handleNewNote({ selection: selectedTextForNote, color });

                    DOM.addNotePopup.style.display = 'none';
                    window.getSelection().removeAllRanges();
                }
            });

            // Listener del scroll para el contador de página
            DOM.pagesContainer.addEventListener('scroll', updatePageNumberIndicator);
        }
    </script>
</body>
</html>
