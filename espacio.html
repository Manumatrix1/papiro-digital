<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Cargando...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f0f0f; }
        #pages-container .pdf-page-container {
            position: relative; /* Clave para posicionar overlays */
            margin-bottom: 1rem;
        }
        .annotation-overlay {
            position: absolute;
            opacity: 0.4;
            border-radius: 3px;
            cursor: pointer;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .annotation-overlay:hover { opacity: 0.6; }
        #sidebar {
            right: -100%;
            transition: right 0.3s ease-in-out;
            max-width: 400px;
            width: 90%;
        }
        #sidebar.open { right: 0; }
        .pdf-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1.5rem; }
        #page-number-indicator {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            display: none;
            z-index: 50;
            transition: opacity 0.3s ease-in-out, visibility 0.3s;
            opacity: 0;
            visibility: hidden;
        }
         #page-number-indicator.visible {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="text-white flex flex-col min-h-screen">
    <header class="bg-[#181818] border-b border-[#2a2a2a] py-3 px-4 sm:px-6 flex justify-between items-center sticky top-0 z-40">
        <div class="flex items-center gap-4">
            <button id="dynamic-back-btn" class="flex items-center text-gray-400 hover:text-white transition group">
                <i class="fas fa-arrow-left h-6 w-6"></i>
                <span id="dynamic-back-text" class="ml-2 font-medium hidden sm:inline">Tablero</span>
            </button>
            <h1 id="project-title-display" class="text-lg sm:text-xl font-bold text-white truncate">Cargando...</h1>
        </div>
        <div class="flex items-center gap-2 sm:gap-4">
             <button id="open-sidebar-btn" title="Abrir Cuaderno" class="bg-gray-700 text-white rounded-lg w-10 h-10 flex items-center justify-center shadow-lg hover:bg-gray-600 transition">
                <i class="fas fa-book"></i>
            </button>
            <button id="logout-btn" class="text-gray-400 hover:text-white transition text-sm sm:text-base">Salir</button>
        </div>
    </header>

    <main class="flex-1 flex flex-col items-center overflow-auto p-4 sm:p-6" id="main-content">
        <div id="grid-view-container" class="w-full max-w-6xl">
             <div id="pdfs-section" class="w-full">
                <div id="pdf-list" class="pdf-grid">
                    <div class="pdf-list-item flex flex-col items-center justify-center bg-[#181818] rounded-lg p-6 shadow-lg border border-dashed border-gray-600 transition hover:bg-[#2a2a2a] cursor-pointer" id="visual-upload-btn" style="aspect-ratio: 1 / 1.41;">
                        <svg class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        <span class="mt-4 font-semibold text-gray-400 text-sm">Nuevo PDF</span>
                    </div>
                </div>
                <input type="file" id="pdf-file-input" class="hidden" accept="application/pdf">
            </div>
        </div>

        <div id="pdf-viewer-container" class="w-full max-w-4xl" style="display: none;">
             <div id="pdf-controls" class="sticky top-[65px] bg-[#141414] z-30 p-3 rounded-b-lg mb-4 flex items-center justify-center gap-6">
                <button id="play-pause-btn" title="Leer texto seleccionado" class="text-white hover:text-[#88c999] transition text-lg"><i class="fas fa-play"></i></button>
                <button id="stop-btn" title="Detener lectura" class="text-white hover:text-red-400 transition text-lg"><i class="fas fa-stop"></i></button>
             </div>
            <div id="pages-container" class="w-full h-full">
                </div>
        </div>
    </main>

    <aside id="sidebar" class="bg-[#181818] text-white fixed top-0 w-full h-full transform translate-x-full transition-transform duration-300 z-50 p-4 flex flex-col border-l border-gray-700">
        <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-700">
            <h3 class="text-xl font-bold">Cuaderno de Notas</h3>
            <button id="close-sidebar-btn" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="mb-4">
            <label class="text-sm font-semibold text-gray-400">Color de Resaltado</label>
            <div id="highlight-tools" class="flex gap-3 mt-2">
                <button class="w-8 h-8 rounded-full border-2 border-white" style="background-color: #facc15;" data-color="#facc15" data-rgba="rgba(250, 204, 21, 0.4)"></button>
                <button class="w-8 h-8 rounded-full border-2 border-transparent" style="background-color: #3b82f6;" data-color="#3b82f6" data-rgba="rgba(59, 130, 246, 0.4)"></button>
                <button class="w-8 h-8 rounded-full border-2 border-transparent" style="background-color: #ef4444;" data-color="#ef4444" data-rgba="rgba(239, 68, 68, 0.4)"></button>
                <button class="w-8 h-8 rounded-full border-2 border-transparent" style="background-color: #22c55e;" data-color="#22c55e" data-rgba="rgba(34, 197, 94, 0.4)"></button>
            </div>
        </div>

        <input type="text" id="search-notes-input" placeholder="Buscar en notas..." class="w-full bg-[#2a2a2a] text-white placeholder-gray-400 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#88c999] mb-4">
        
        <div id="notes-list" class="space-y-3 overflow-y-auto flex-1">
            <p id="no-notes-message" class="text-gray-500 text-center mt-8">Selecciona texto en el PDF para crear tu primera anotación.</p>
        </div>
    </aside>
    
    <div id="page-number-indicator"></div>
    <div id="pdf-loader-container" class="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-[9999]" style="display: none;">
        <div class="text-center"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-[#88c999]"></div><p id="pdf-loader-text" class="mt-4 text-xl">Cargando...</p></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, getDoc, addDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYVYRdA_DB1Kob9b_wGd5Wd4JsYFMyBRc",
            authDomain: "papiro2025-d09e0.firebaseapp.com",
            projectId: "papiro2025-d09e0",
            storageBucket: "papiro2025-d09e0.appspot.com",
            messagingSenderId: "1096335704864",
            appId: "1:1096335704864:web:75f1f27cd920df64554d45"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // --- ESTADO GLOBAL ---
        let currentUser = null;
        let currentProjectId = null;
        let currentPdfId = null;
        let pdfDocument = null; 
        let unsubscribeHighlights = null;
        let highlightColor = '#facc15'; 
        let highlightRgba = 'rgba(250, 204, 21, 0.4)';
        let pageRenderQueue = [];
        let isRendering = false;

        // --- ELEMENTOS DEL DOM ---
        const projectTitleDisplay = document.getElementById('project-title-display');
        const pdfLoaderContainer = document.getElementById('pdf-loader-container');
        const pdfLoaderText = document.getElementById('pdf-loader-text');
        const gridViewContainer = document.getElementById('grid-view-container');
        const pdfViewerContainer = document.getElementById('pdf-viewer-container');
        const pagesContainer = document.getElementById('pages-container');
        const dynamicBackBtn = document.getElementById('dynamic-back-btn');
        const pdfList = document.getElementById('pdf-list');
        const pdfFileInput = document.getElementById('pdf-file-input');
        const pageNumberIndicator = document.getElementById('page-number-indicator');
        
        // --- ELEMENTOS DEL CUADERNO Y VOZ ---
        const sidebar = document.getElementById('sidebar');
        const openSidebarBtn = document.getElementById('open-sidebar-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const highlightTools = document.getElementById('highlight-tools');
        const notesList = document.getElementById('notes-list');
        const noNotesMessage = document.getElementById('no-notes-message');
        const searchNotesInput = document.getElementById('search-notes-input');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const stopBtn = document.getElementById('stop-btn');

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // --- INICIALIZACIÓN Y AUTENTICACIÓN ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = user;
            const urlParams = new URLSearchParams(window.location.search);
            currentProjectId = urlParams.get('id');
            const docId = urlParams.get('docId');

            if (!currentProjectId) {
                window.location.href = 'mi_tablero.html';
                return;
            }

            const projectRef = doc(db, "users", currentUser.uid, "projects", currentProjectId);
            const projectDoc = await getDoc(projectRef);
            if (projectDoc.exists()) {
                projectTitleDisplay.textContent = projectDoc.data().name;
            }

            if (docId) {
                currentPdfId = docId;
                await loadPDFViewer(currentPdfId);
                openSidebarBtn.style.display = 'flex';
            } else {
                loadPdfGrid();
                openSidebarBtn.style.display = 'none';
            }
        });
        
        // --- VISTA DE GRILLA ---
        function loadPdfGrid() {
            gridViewContainer.style.display = 'block';
            pdfViewerContainer.style.display = 'none';
            const pdfsQuery = query(collection(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs"));
            onSnapshot(pdfsQuery, (snapshot) => {
                pdfList.querySelectorAll('.pdf-card').forEach(card => card.remove());
                snapshot.forEach(createPdfCard);
            });
            document.getElementById('visual-upload-btn').addEventListener('click', () => pdfFileInput.click());
        }

        function createPdfCard(pdfDoc) {
            const pdfData = pdfDoc.data();
            const card = document.createElement('div');
            card.className = 'pdf-card bg-[#181818] rounded-lg p-4 flex flex-col justify-between shadow-lg border border-[#2a2a2a] transition hover:border-[#88c999] cursor-pointer';
            card.style.aspectRatio = '1 / 1.41';
            card.innerHTML = `<h3 class="font-bold text-white truncate">${pdfData.name}</h3> <p class="text-sm text-gray-400 truncate">${pdfData.fileName}</p>`;
            card.addEventListener('click', () => window.location.search = `?id=${currentProjectId}&docId=${pdfDoc.id}`);
            pdfList.insertBefore(card, document.getElementById('visual-upload-btn'));
        }

        pdfFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || file.type !== 'application/pdf') return;

            showLoader("Subiendo PDF...");
            const newPdfDocRef = doc(collection(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs"));
            const storageRef = ref(storage, `proyectos/${currentUser.uid}/${currentProjectId}/pdfs/${newPdfDocRef.id}-${file.name}`);
            const uploadTask = uploadBytesResumable(storageRef, file);
            uploadTask.on('state_changed', 
                (s) => pdfLoaderText.textContent = `Subiendo: ${Math.round((s.bytesTransferred / s.totalBytes) * 100)}%`,
                (err) => { hideLoader(); console.error(err); Swal.fire('Error', 'No se pudo subir el PDF.', 'error'); },
                async () => {
                    const url = await getDownloadURL(uploadTask.snapshot.ref);
                    await setDoc(newPdfDocRef, { name: file.name.replace('.pdf', ''), fileName: file.name, url, createdAt: new Date() });
                    hideLoader();
                }
            );
        });

        // --- VISOR DE PDF ---
        async function loadPDFViewer(pdfId) {
            showLoader("Cargando documento...");
            gridViewContainer.style.display = 'none';
            pdfViewerContainer.style.display = 'block';

            const pdfDocRef = doc(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs", pdfId);
            const pdfDocSnap = await getDoc(pdfDocRef);
            if (!pdfDocSnap.exists()) {
                hideLoader();
                Swal.fire('Error', 'Documento no encontrado.', 'error');
                return;
            }
            projectTitleDisplay.textContent = pdfDocSnap.data().name;

            const loadingTask = pdfjsLib.getDocument(pdfDocSnap.data().url);
            pdfDocument = await loadingTask.promise;
            pagesContainer.innerHTML = '';
            
            for (let i = 1; i <= pdfDocument.numPages; i++) {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'pdf-page-container';
                pageDiv.dataset.pageNumber = i;
                const canvas = document.createElement('canvas');
                canvas.className = 'w-full h-auto shadow-lg bg-white';
                pageDiv.appendChild(canvas);
                pagesContainer.appendChild(pageDiv);
                pageRenderQueue.push(i);
            }
            
            processRenderQueue();
            loadAndDrawAnnotations();
            main-content.addEventListener('scroll', handleScroll, { passive: true });
            pagesContainer.addEventListener('mouseup', handleTextSelection);
            hideLoader();
        }

        function processRenderQueue() {
            if (isRendering || pageRenderQueue.length === 0) return;
            isRendering = true;
            const pageNum = pageRenderQueue.shift();
            renderPage(pageNum).then(() => {
                isRendering = false;
                processRenderQueue();
            });
        }

        async function renderPage(pageNum) {
            const page = await pdfDocument.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.8 });
            const canvas = pagesContainer.querySelector(`[data-page-number="${pageNum}"] canvas`);
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: context, viewport }).promise;
        }

        // --- FUNCIONALIDAD DE ANOTACIONES ---
        function loadAndDrawAnnotations() {
            if (unsubscribeHighlights) unsubscribeHighlights();
            const highlightsQuery = query(collection(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs", currentPdfId, "highlights"));
            unsubscribeHighlights = onSnapshot(highlightsQuery, (snapshot) => {
                document.querySelectorAll('.annotation-overlay').forEach(el => el.remove());
                notesList.innerHTML = '';
                noNotesMessage.style.display = snapshot.empty ? 'block' : 'none';
                
                snapshot.docs.sort((a, b) => a.data().createdAt.seconds - b.data().createdAt.seconds).forEach(doc => {
                    const data = doc.data();
                    drawAnnotation(data);
                    createNoteCard(data, doc.id);
                });
            });
        }

        function drawAnnotation(data) {
            const pageDiv = pagesContainer.querySelector(`[data-page-number="${data.page}"]`);
            if (!pageDiv) return;
            data.rectangles.forEach(rect => {
                const overlay = document.createElement('div');
                overlay.className = 'annotation-overlay';
                overlay.style.backgroundColor = data.rgba;
                overlay.style.left = `${rect.left}px`;
                overlay.style.top = `${rect.top}px`;
                overlay.style.width = `${rect.width}px`;
                overlay.style.height = `${rect.height}px`;
                pageDiv.appendChild(overlay);
            });
        }
        
        async function handleTextSelection() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            if (!selectedText) return;

            const range = selection.getRangeAt(0);
            const pageElement = range.startContainer.parentElement.closest('.pdf-page-container');
            if (!pageElement) return;

            const pageNum = parseInt(pageElement.dataset.pageNumber);
            const pageRect = pageElement.getBoundingClientRect();
            const selectionRects = Array.from(range.getClientRects()).map(rect => ({
                top: rect.top - pageRect.top + main-content.scrollTop,
                left: rect.left - pageRect.left,
                width: rect.width,
                height: rect.height
            }));

            selection.removeAllRanges(); // Limpiar la selección visualmente

            const { value: result } = await Swal.fire({
                title: 'Añadir Anotación',
                html: `<p class="text-sm text-gray-400 text-left mb-2 line-clamp-2">Resaltado: "${selectedText}"</p>
                       <textarea id="swal-note" class="swal2-textarea" placeholder="Escribe tu nota aquí..." style="min-height: 100px;"></textarea>
                       <input id="swal-tags" class="swal2-input" placeholder="Etiquetas (ej: importante, examen)">`,
                focusConfirm: false,
                confirmButtonText: 'Guardar',
                showCancelButton: true,
                cancelButtonText: 'Cancelar',
                background: '#181818',
                color: '#fff',
                preConfirm: () => ({
                    note: document.getElementById('swal-note').value,
                    tags: document.getElementById('swal-tags').value.split(',').map(t => t.trim()).filter(Boolean)
                })
            });

            if (result) {
                const highlightsRef = collection(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs", currentPdfId, "highlights");
                await addDoc(highlightsRef, {
                    text: selectedText, note: result.note, tags: result.tags, page: pageNum, 
                    rectangles: selectionRects, color: highlightColor, rgba: highlightRgba, createdAt: new Date()
                });
            }
        }

        // --- UI DEL CUADERNO ---
        function createNoteCard(data, docId) {
            const card = document.createElement('div');
            card.className = 'note-card bg-[#2a2a2a] p-3 rounded-lg cursor-pointer hover:bg-gray-700';
            card.dataset.fulltext = `${data.text} ${data.note} ${data.tags.join(' ')}`.toLowerCase();
            card.style.borderLeft = `4px solid ${data.color}`;

            card.innerHTML = `
                <p class="text-xs text-gray-400 mb-1">Página ${data.page}</p>
                <p class="font-semibold text-sm text-white line-clamp-2">"${data.text}"</p>
                <p class="text-sm text-gray-300 mt-1 line-clamp-3">${data.note || '<i>Sin nota adicional</i>'}</p>
                <div class="mt-2 flex flex-wrap gap-1">
                    ${data.tags.map(tag => `<span class="bg-gray-500 text-white text-xs font-bold px-2 py-1 rounded-full">${tag}</span>`).join('')}
                </div>`;
            card.addEventListener('click', () => { // Scroll a la anotación
                 const pageDiv = pagesContainer.querySelector(`[data-page-number="${data.page}"]`);
                 if(pageDiv) {
                    main-content.scrollTo({ top: pageDiv.offsetTop - 80, behavior: 'smooth' });
                    sidebar.classList.remove('open');
                 }
            });
            notesList.appendChild(card);
        }

        highlightTools.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.color) {
                highlightColor = button.dataset.color;
                highlightRgba = button.dataset.rgba;
                highlightTools.querySelectorAll('button').forEach(btn => btn.style.borderColor = 'transparent');
                button.style.borderColor = 'white';
            }
        });
        
        searchNotesInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            notesList.querySelectorAll('.note-card').forEach(card => {
                card.style.display = card.dataset.fulltext.includes(term) ? 'block' : 'none';
            });
        });

        openSidebarBtn.addEventListener('click', () => sidebar.classList.add('open'));
        closeSidebarBtn.addEventListener('click', () => sidebar.classList.remove('open'));

        // --- FUNCIONES RESTAURADAS: VOZ Y CONTEO DE PÁGINA ---
        const synthesis = window.speechSynthesis;
        let utterance = null;
        let isSpeaking = false;

        async function speakText(text) {
            if (synthesis.speaking) synthesis.cancel();
            
            let textToRead = text;
            if(!textToRead) { // Si no hay texto seleccionado, intenta leer el contenido de la página actual
                 const currentPage = findCurrentPage();
                 const page = await pdfDocument.getPage(currentPage);
                 const content = await page.getTextContent();
                 textToRead = content.items.map(item => item.str).join(' ');
            }
            if(!textToRead) {
                Swal.fire({title: 'Nada para leer', text:'Selecciona texto o desplázate a una página con texto.', icon:'info', background:'#181818', color: '#fff' });
                return;
            }

            utterance = new SpeechSynthesisUtterance(textToRead);
            utterance.onstart = () => { isSpeaking = true; playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>'; };
            utterance.onend = () => { isSpeaking = false; playPauseBtn.innerHTML = '<i class="fas fa-play"></i>'; };
            utterance.onerror = () => { isSpeaking = false; playPauseBtn.innerHTML = '<i class="fas fa-play"></i>'; };
            synthesis.speak(utterance);
        }
        
        playPauseBtn.addEventListener('click', () => {
            if(isSpeaking) {
                synthesis.pause();
                isSpeaking = false;
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            } else if (synthesis.paused) {
                 synthesis.resume();
                 isSpeaking = true;
                 playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            } else {
                speakText(window.getSelection().toString());
            }
        });

        stopBtn.addEventListener('click', () => {
            if (synthesis.speaking) synthesis.cancel();
        });
        
        let scrollTimeout;
        function handleScroll() {
            if (!pdfDocument) return;
            const currentPage = findCurrentPage();
            pageNumberIndicator.textContent = `${currentPage} / ${pdfDocument.numPages}`;
            pageNumberIndicator.classList.add('visible');
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                pageNumberIndicator.classList.remove('visible');
            }, 1500);
        }
        
        function findCurrentPage() {
             const scrollPosition = main-content.scrollTop + (window.innerHeight / 2);
             const pages = Array.from(pagesContainer.children);
             const currentPage = pages.find(p => scrollPosition >= p.offsetTop && scrollPosition <= p.offsetTop + p.offsetHeight);
             return currentPage ? parseInt(currentPage.dataset.pageNumber) : 1;
        }

        // --- NAVEGACIÓN Y OTROS ---
        dynamicBackBtn.addEventListener('click', () => window.location.search = `?id=${currentProjectId}`);
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        function showLoader(message) { pdfLoaderText.textContent = message; pdfLoaderContainer.style.display = 'flex'; }
        function hideLoader() { pdfLoaderContainer.style.display = 'none'; }
    </script>
</body>
</html>
