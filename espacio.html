<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Papiro Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --background-color: #0f0f0f;
            --surface-color: #181818;
            --surface-border-color: #2a2a2a;
            --primary-color: #88c999;
        }
        .hidden { display: none !important; }
        html { height: 100%; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #grid-view-container, #pdf-viewer-container {
            padding: 1.5rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        #pdf-viewer-container {
             padding: 0.5rem;
        }
        .pdf-page-container {
            position: relative;
            margin: 0 auto 1rem auto;
            max-width: 100%; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .pdf-page-container canvas {
            width: 100% !important;
            height: auto !important;
            display: block;
        }
        .pdf-card {
            transition: transform 0.2s ease;
            background-color: var(--surface-color);
            border: 1px solid var(--surface-border-color);
        }
        .pdf-card:hover { transform: translateY(-5px); }
    </style>
</head>
<body>
    <div id="page-loader" class="fixed inset-0 bg-[#0f0f0f] flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-color"></div>
        <p id="page-loader-text" class="mt-4 text-xl">Iniciando...</p>
    </div>

    <div id="main-content" class="hidden flex-col h-full">
        <header class="bg-surface-color border-b border-surface-border-color py-3 px-4 sm:px-8 flex justify-between items-center sticky top-0 z-20 flex-shrink-0">
            <div class="flex items-center gap-4 flex-1 min-w-0">
                <button id="dynamic-back-btn" class="flex-shrink-0 flex items-center text-gray-400 hover:text-white transition group"><i class="fas fa-arrow-left text-xl"></i></button>
                <h2 id="project-title" class="text-lg sm:text-xl font-bold text-white truncate">Cargando...</h2>
            </div>
            <button id="logout-btn" class="text-gray-400 hover:text-white transition"><i class="fas fa-sign-out-alt text-xl"></i></button>
        </header>

        <main class="flex-grow flex flex-col overflow-hidden">
            <div id="grid-view-container" class="w-full max-w-5xl mx-auto hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-semibold">Documentos</h2>
                </div>
                <div id="pdfs-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                <div id="no-pdfs-message" class="text-gray-400 text-center mt-8 hidden">No hay PDFs en este tablero.</div>
            </div>
            <div id="pdf-viewer-container" class="relative w-full flex-grow hidden">
                <div id="pages-container" class="flex-grow w-full h-full"><div id="pdf-content" class="w-full"></div></div>
            </div>
        </main>
    </div>

    <script type="module">
        // FIX: Usando el método de importación de módulos, el único correcto y moderno.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, collection, query, doc, onSnapshot, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyBYVYRdA_DB1Kob9b_wGd5Wd4JsYFMyBRc", authDomain: "papiro2025-d09e0.firebaseapp.com", projectId: "papiro2025-d09e0", storageBucket: "papiro2025-d09e0.firebasestorage.app", messagingSenderId: "1096335704864", appId: "1:1096335704864:web:75f1f27cd920df64554d45"};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let currentUser, currentProjectId, currentPdfId, pdfDocument;
        const DOM = {
            pageLoader: document.getElementById('page-loader'), mainContent: document.getElementById('main-content'), projectTitle: document.getElementById('project-title'), gridView: document.getElementById('grid-view-container'), pdfViewer: document.getElementById('pdf-viewer-container'), pdfsGrid: document.getElementById('pdfs-grid'), noPdfsMessage: document.getElementById('no-pdfs-message'), pagesContainer: document.getElementById('pages-container'), pdfContent: document.getElementById('pdf-content'), dynamicBackBtn: document.getElementById('dynamic-back-btn'), logoutBtn: document.getElementById('logout-btn'),
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const urlParams = new URLSearchParams(window.location.search);
                currentProjectId = urlParams.get('id');
                currentPdfId = urlParams.get('docId');
                if (!currentProjectId) { window.location.href = 'mi_tablero.html'; return; }
                initializePage();
            } else { window.location.href = 'index.html'; }
        });

        async function initializePage() {
            await loadProjectDetails();
            addEventListeners();
            if (currentPdfId) { await showView('viewer'); } 
            else { await showView('grid'); }
            DOM.mainContent.classList.remove('hidden');
            DOM.pageLoader.classList.add('hidden');
        }

        async function showView(viewName) {
            DOM.gridView.classList.toggle('hidden', viewName !== 'grid');
            DOM.pdfViewer.classList.toggle('hidden', viewName !== 'viewer');
            if (viewName === 'viewer') {
                DOM.pdfViewer.classList.add('flex', 'flex-col');
                await loadAndRenderPDF(currentPdfId);
            } else {
                DOM.gridView.classList.add('flex', 'flex-col');
                loadPdfsForProject();
            }
        }

        async function loadProjectDetails() {
            const projectRef = doc(db, "users", currentUser.uid, "projects", currentProjectId);
            const projectSnap = await getDoc(projectRef);
            if (projectSnap.exists()) DOM.projectTitle.textContent = projectSnap.data().name;
        }

        function loadPdfsForProject() {
            const q = query(collection(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                DOM.pdfsGrid.innerHTML = '';
                DOM.noPdfsMessage.classList.toggle('hidden', !snapshot.empty);
                snapshot.forEach(pdfDoc => {
                    const pdfData = pdfDoc.data();
                    const card = document.createElement('a');
                    card.href = `espacio.html?id=${currentProjectId}&docId=${pdfDoc.id}`;
                    card.className = 'pdf-card rounded-lg shadow-lg cursor-pointer flex flex-col aspect-[2/3]';
                    card.innerHTML = `<div class="flex-grow w-full bg-gray-800 rounded-t-lg flex items-center justify-center p-2"><i class="fas fa-file-pdf text-4xl text-gray-500"></i></div><div class="p-2 h-1/4 flex items-center justify-center"><p class="w-full text-center text-sm font-semibold text-white truncate">${pdfData.name || 'Documento'}</p></div>`;
                    DOM.pdfsGrid.appendChild(card);
                });
            }, (error) => {
                console.error("Error cargando PDFs:", error);
                DOM.noPdfsMessage.textContent = 'Error al cargar. Asegúrate de tener los índices de Firestore creados (ver consola F12).';
                DOM.noPdfsMessage.classList.remove('hidden');
            });
        }
        
        async function loadAndRenderPDF(docId) {
            document.getElementById('page-loader-text').textContent = 'Cargando documento...';
            DOM.pageLoader.classList.remove('hidden');
            try {
                const pdfDocRef = doc(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs", docId);
                const pdfDocSnap = await getDoc(pdfDocRef);
                if (!pdfDocSnap.exists()) throw new Error("PDF no encontrado");
                pdfDocument = await pdfjsLib.getDocument(pdfDocSnap.data().url).promise;
                DOM.pdfContent.innerHTML = '';
                
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const pageNum = parseInt(entry.target.dataset.pageNum);
                            renderPage(pageNum);
                            observer.unobserve(entry.target);
                        }
                    });
                }, { rootMargin: '300px' });

                for (let i = 1; i <= pdfDocument.numPages; i++) {
                    const pagePlaceholder = document.createElement('div');
                    pagePlaceholder.id = `page-container-${i}`;
                    pagePlaceholder.className = 'pdf-page-container';
                    pagePlaceholder.dataset.pageNum = i;
                    pagePlaceholder.style.minHeight = '1000px';
                    DOM.pdfContent.appendChild(pagePlaceholder);
                    observer.observe(pagePlaceholder);
                }
            } catch (error) { console.error("Error cargando PDF:", error);
            } finally { DOM.pageLoader.classList.add('hidden'); }
        }

        async function renderPage(pageNum) {
            const pageContainer = document.getElementById(`page-container-${pageNum}`);
            if (pageContainer.querySelector('canvas')) return;

            const page = await pdfDocument.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.5 });
            
            pageContainer.style.width = `${viewport.width}px`;
            pageContainer.style.height = `${viewport.height}px`;
            pageContainer.style.minHeight = '0';
            
            const canvas = document.createElement('canvas');
            canvas.height = viewport.height; canvas.width = viewport.width;
            pageContainer.appendChild(canvas);

            await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
        }

        function addEventListeners() {
            DOM.dynamicBackBtn.addEventListener('click', () => {
                if (currentPdfId) {
                    window.location.href = `espacio.html?id=${currentProjectId}`;
                } else {
                    window.location.href = 'mi_tablero.html';
                }
            });
            DOM.logoutBtn.addEventListener('click', () => signOut(auth));
        }
    </script>
</body>
</html>
