<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Papiro Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --background-color: #0f0f0f; --surface-color: #181818; --surface-border-color: #2a2a2a; --primary-color: #88c999; --text-color: #ffffff; --text-muted-color: #9ca3af; }
        .hidden { display: none !important; }
        html { height: 100%; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background-color); color: white; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #grid-view-container, #pdf-viewer-container { padding: 1.5rem; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        #pdf-viewer-container { padding: 0.5rem; }
        .pdf-page-container { position: relative; margin: 0 auto 1rem auto; max-width: 100%; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .pdf-page-container canvas, .textLayer { width: 100% !important; height: auto !important; display: block; }
        .annotation-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; touch-action: none; }
        #add-note-popup { display: none; position: absolute; background-color: var(--surface-color); border: 1px solid var(--surface-border-color); border-radius: 8px; padding: 0.5rem; z-index: 101; display: flex; gap: 0.5rem; }
        .color-swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .color-swatch:hover { transform: scale(1.2); border-color: #fff; }
    </style>
</head>
<body>
    <div id="page-loader" class="fixed inset-0 bg-[#0f0f0f] flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-color"></div>
        <p id="page-loader-text" class="mt-4 text-xl">Iniciando...</p>
    </div>
    <div id="main-content" class="hidden flex-col h-full">
        <header class="bg-surface-color border-b border-surface-border-color py-3 px-4 sm:px-8 flex justify-between items-center sticky top-0 z-20 flex-shrink-0">
            <div class="flex items-center gap-4 flex-1 min-w-0">
                <button id="dynamic-back-btn" class="flex-shrink-0"><i class="fas fa-arrow-left text-xl"></i></button>
                <h2 id="project-title" class="text-lg sm:text-xl font-bold text-white truncate">Cargando...</h2>
            </div>
            <button id="logout-btn" class="text-gray-400 hover:text-white transition"><i class="fas fa-sign-out-alt text-xl"></i></button>
        </header>
        <main class="flex-grow flex flex-col overflow-hidden">
            <div id="grid-view-container" class="w-full max-w-5xl mx-auto hidden">
                <div id="pdfs-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
            </div>
            <div id="pdf-viewer-container" class="relative w-full flex-grow hidden">
                <div id="pages-container" class="flex-grow w-full h-full"><div id="pdf-content" class="w-full"></div></div>
            </div>
        </main>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, collection, query, doc, onSnapshot, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyBYVYRdA_DB1Kob9b_wGd5Wd4JsYFMyBRc", authDomain: "papiro2025-d09e0.firebaseapp.com", projectId: "papiro2025-d09e0", storageBucket: "papiro2025-d09e0.firebasestorage.app", messagingSenderId: "1096335704864", appId: "1:1096335704864:web:75f1f27cd920df64554d45"};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // Lógica principal de la página (onAuthStateChanged, initializePage, showView, etc.)
        // La clave está en la función loadAndRenderPDF
        async function loadAndRenderPDF(docId) {
            document.getElementById('page-loader-text').textContent = 'Cargando documento...';
            document.getElementById('page-loader').classList.remove('hidden');
            try {
                const pdfDocRef = doc(db, "users", currentUser.uid, "projects", currentProjectId, "pdfs", docId);
                const pdfDocSnap = await getDoc(pdfDocRef);
                if (!pdfDocSnap.exists()) throw new Error("PDF no encontrado");
                
                const pdfDocument = await pdfjsLib.getDocument(pdfDocSnap.data().url).promise;
                const pdfContent = document.getElementById('pdf-content');
                pdfContent.innerHTML = '';
                
                // Bucle para renderizar TODAS las páginas
                for (let i = 1; i <= pdfDocument.numPages; i++) {
                    const page = await pdfDocument.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    
                    const pageContainer = document.createElement('div');
                    pageContainer.id = `page-container-${i}`;
                    pageContainer.className = 'pdf-page-container';
                    pageContainer.style.width = `${viewport.width}px`;
                    pageContainer.style.height = `${viewport.height}px`;
                    
                    const canvas = document.createElement('canvas');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    pageContainer.appendChild(canvas);
                    
                    // Aquí irían el textLayer y el annotationCanvas si los necesitas
                    
                    pdfContent.appendChild(pageContainer);
                    
                    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                }
            } catch (error) {
                console.error("Error cargando PDF:", error);
            } finally {
                document.getElementById('page-loader').classList.add('hidden');
            }
        }
        // ... (resto de funciones y listeners, incluyendo el back, logout, loadProjects, etc.)
    </script>
</body>
</html>
