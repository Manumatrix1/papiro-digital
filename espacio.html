<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title id="page-title">Papiro Digital v2.0 - Actualizado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-color: #88c999; --background-color: #0f0f0f;
            --surface-color: #181818; --surface-border-color: #2a2a2a;
        }
        html, body { height: 100%; width: 100%; overflow: hidden; background-color: var(--background-color); color: white; font-family: 'Inter', sans-serif; }
        .app-container { height: 100vh; display: flex; flex-direction: column; background-color: var(--background-color); position: relative; }
        main { flex-grow: 1; position: relative; overflow: hidden; }
        .scroll-wrapper {
            width: 100%; height: 100%;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        #zoom-container { width: 100%; transition: width 0.1s, height 0.1s; }
        #pdf-content-wrapper { width: 100%; transform-origin: top left; }
        .pdf-page-container {
            position: relative;
            margin: 0 auto 1rem auto;
            width: 95%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            background-color: #2a2a2a;
        }
        .pdf-page-container canvas { display: block; width:100%; height:auto; }
        .annotation-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
        }
        .tool-btn { background: none; border: none; color: #9ca3af; cursor: pointer; padding: 0.5rem; }
        .tool-btn.active { color: var(--primary-color); }
        #sidebar {
            position: fixed; top: 0; right: 0;
            width: 350px;
            max-width: 90vw;
            height: 100%;
            background-color: var(--surface-color);
            transition: transform 0.3s ease-in-out;
            z-index: 110; display: flex; flex-direction: column;
            border-left: 1px solid var(--surface-border-color);
            transform: translateX(100%);
        }
        #sidebar.open {
            transform: translateX(0);
        }
        #sidebar-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); z-index: 105; display: none; }
        #sidebar.open + #sidebar-overlay { display: block; }
        #page-indicator {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 50px;
            height: 50px;
            background-color: var(--surface-color);
            border: 1px solid var(--surface-border-color);
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
            color: #9ca3af;
            z-index: 50;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: opacity 0.3s;
        }
        #note-search-input, #pdf-search-input {
            width: 100%; background-color: #2a2a2a; border: 1px solid #4a4a4a;
            border-radius: 0.5rem; padding: 0.5rem 0.75rem; color: white; font-size: 0.875rem;
        }
        #add-note-btn {
            background-color: var(--primary-color); color: black; border-radius: 9999px;
            width: 32px; height: 32px; font-size: 1.5rem; line-height: 1; font-weight: bold;
        }
        .clear-btn {
            flex-grow: 1; padding: 0.5rem; font-size: 0.75rem; font-weight: 600;
            background-color: #3a3a3a; color: #a0a0a0; border-radius: 0.5rem;
            border: 1px solid #5a5a5a;
        }
        .clear-btn:hover { background-color: #4a4a4a; color: white; }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="bg-surface-color border-b border-[#2a2a2a] py-2 px-3 flex justify-between items-center w-full flex-shrink-0 z-20">
            <a href="mi_tablero.html" class="p-2 rounded-md hover:bg-[#2a2a2a]"><i class="fas fa-arrow-left"></i></a>
            <h1 id="project-title" class="text-md font-bold text-white truncate mx-2 flex-1 min-w-0"></h1>
            <div id="main-tools" class="flex items-center gap-1 flex-shrink-0">
                <button class="tool-btn active" id="tool-select" title="Mover"><i class="fas fa-hand-paper"></i></button>
                <button class="tool-btn" id="tool-draw" title="Dibujar"><i class="fas fa-pencil-alt"></i></button>
                <button class="tool-btn" id="tool-highlight" title="Resaltar"><i class="fas fa-highlighter"></i></button>
                <button class="tool-btn" id="tool-erase" title="Borrar"><i class="fas fa-eraser"></i></button>
                <input type="color" id="color-picker" class="w-8 h-8 rounded-full cursor-pointer bg-transparent border-none p-1" value="#FFDD00" title="Color">
                <div class="w-px h-6 bg-[#2a2a2a] mx-2"></div>
                <button id="fullscreen-btn" class="p-2 rounded-md hover:bg-[#2a2a2a]" title="Pantalla Completa"><i class="fas fa-expand"></i></button>
                <button id="open-notes-btn" class="p-2 rounded-md hover:bg-[#2a2a2a]" title="Ver Cuaderno"><i class="fas fa-book"></i></button>
            </div>
        </header>
        <main id="pdf-viewer-area">
            <div class="scroll-wrapper">
                <div id="status-indicator" class="text-white text-center p-8 flex flex-col items-center m-auto">
                    <p id="status-text">Verificando sesión...</p>
                </div>
                <div id="zoom-container">
                    <div id="pdf-content-wrapper" style="display: none;"></div>
                </div>
            </div>
            <span id="page-indicator">1 / 1</span>
        </main>
        <aside id="sidebar" class="p-4">
            <div class="flex justify-between items-center mb-2 flex-shrink-0">
                <h3 class="text-xl font-bold">Cuaderno de Notas</h3>
                <div class="flex items-center gap-2">
                    <button id="add-note-btn" title="Añadir Nota de Texto">+</button>
                    <button id="close-sidebar-btn" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="flex gap-2 mb-4 flex-shrink-0">
                <button id="clear-notes-btn" class="clear-btn">Limpiar Notas</button>
                <button id="clear-all-btn" class="clear-btn">Limpiar Todo</button>
            </div>
            <div id="notes-list" class="flex-grow overflow-y-auto"></div>
        </aside>
        <div id="sidebar-overlay"></div>
    </div>

    <!-- Scripts externos -->
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        console.log('🔧 NUEVA VERSIÓN CARGADA - v2.0 - COMPLETAMENTE REPARADA');
        console.log('🚨 Sistema de emergencia PDF listo');
    </script>
    <script src="./cache-buster.js?v=2.0&t=1729283400"></script>
    <script src="./emergency-pdf-fix.js?v=2.0&t=1729283400"></script>
    <script src="./force-emergency-load.js?v=2.0&t=1729283400"></script>
    <script src="./ultimate-pdf-fix.js?v=2.0&t=1729283400"></script>

    <!-- Script principal completamente funcional -->
    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { doc, getDoc, collection, query, onSnapshot, addDoc, serverTimestamp, updateDoc, deleteDoc, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // Variables globales
        let currentUser, projectId, pdfId, pdfDocument;
        let annotationsUnsubscribe;
        let activeTool = 'select', activeColor = '#FFDD00', isDrawing = false;
        let annotationsByPage = {}, currentPath = [];
        let currentPageNum = 1;

        // Referencias DOM
        const pdfWrapper = document.getElementById('pdf-content-wrapper');
        const scrollContainer = document.querySelector('.scroll-wrapper');
        const notesList = document.getElementById('notes-list');
        let pageIntersectionObserver;

        // Inicialización cuando hay usuario autenticado
        onAuthStateChanged(auth, (user) => {
            if (user) {
                iniciarAplicacion(user);
            } else {
                window.location.href = 'index.html';
            }
        });

        function iniciarAplicacion(user) {
            currentUser = user;
            const urlParams = new URLSearchParams(window.location.search);
            projectId = urlParams.get('id');
            pdfId = urlParams.get('pdfId');

            if (!projectId || !pdfId) {
                window.location.href = 'mi_tablero.html';
                return;
            }

            setupAllEventListeners();
            loadPdfDocument();
        }

        // Configurar todos los event listeners
        function setupAllEventListeners() {
            // Herramientas
            document.getElementById('tool-select')?.addEventListener('click', () => setActiveTool('select'));
            document.getElementById('tool-draw')?.addEventListener('click', () => setActiveTool('draw'));
            document.getElementById('tool-highlight')?.addEventListener('click', () => setActiveTool('highlight'));
            document.getElementById('tool-erase')?.addEventListener('click', () => setActiveTool('erase'));
            document.getElementById('color-picker')?.addEventListener('input', (e) => activeColor = e.target.value);

            // Notas
            document.getElementById('open-notes-btn')?.addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('open');
            });
            document.getElementById('close-sidebar-btn')?.addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('open');
            });
            document.getElementById('sidebar-overlay')?.addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('open');
            });

            // Botones de acción
            document.getElementById('add-note-btn')?.addEventListener('click', handleAddNewNote);
            document.getElementById('clear-notes-btn')?.addEventListener('click', handleClearNotes);
            document.getElementById('clear-all-btn')?.addEventListener('click', handleClearAll);

            console.log('✅ Event listeners configurados');
        }

        // 🚨 FUNCIÓN PRINCIPAL DE CARGA DE PDF (REPARADA COMPLETAMENTE)
        async function loadPdfDocument() {
            const statusText = document.getElementById('status-text');

            try {
                console.log('� NUEVA VERSIÓN v2.0 ACTIVA - Sistema completamente reparado');
                console.log('�🚨 Iniciando carga de PDF con sistema de emergencia...');
                statusText.textContent = '🚨 Cargando PDF con sistema anti-CORS...';

                if (!currentUser || !projectId || !pdfId) {
                    throw new Error("Faltan datos de usuario o proyecto");
                }

                // Obtener datos del PDF de Firebase
                const pdfDocRef = doc(db, "users", currentUser.uid, "projects", projectId, "pdfs", pdfId);
                const docSnap = await getDoc(pdfDocRef);

                if (!docSnap?.exists()) {
                    throw new Error("Documento no encontrado");
                }

                const pdfUrl = docSnap.data().url;
                if (!pdfUrl) {
                    throw new Error("URL del PDF no encontrada");
                }

                // Manejador de contraseña
                const onPasswordCallback = (callback) => {
                    Swal.fire({
                        title: 'PDF Protegido',
                        input: 'password',
                        inputPlaceholder: 'Introduce la contraseña',
                        showCancelButton: true,
                        preConfirm: (password) => { 
                            if (password) callback(password); 
                        }
                    });
                };

                // 🚨 USAR EL SISTEMA DEFINITIVO (SIN PROXIES)
                console.log('🚨 Activando cargador definitivo...');
                pdfDocument = await window.ultimatePDFLoader.loadPDF(pdfUrl, onPasswordCallback);

                if (pdfDocument) {
                    statusText.textContent = '✅ PDF cargado correctamente';
                    document.getElementById('status-indicator').style.display = 'none';
                    pdfWrapper.style.display = 'block';

                    await setupPagePlaceholders();
                    loadAllAnnotations();

                    console.log('✅ PDF completamente cargado y configurado');
                } else {
                    // Si falló, mostrar modal de emergencia mejorado
                    console.log('❌ Carga falló - Mostrando modal definitivo');
                    window.ultimatePDFLoader.showEmergencyModal(pdfUrl);
                }

            } catch (error) {
                console.error('❌ Error en carga de PDF:', error);
                statusText.textContent = '❌ Error al cargar PDF';

                Swal.fire({
                    title: 'Error',
                    text: 'No se pudo cargar el PDF. Intenta recargar la página.',
                    icon: 'error',
                    confirmButtonText: 'Recargar',
                    allowOutsideClick: false
                }).then(() => {
                    location.reload();
                });
            }
        }

        // Configurar placeholders de páginas
        async function setupPagePlaceholders() {
            if (!pdfDocument) return;

            pdfWrapper.innerHTML = '';
            const page = await pdfDocument.getPage(1);
            const viewport = page.getViewport({ scale: 1.0 });
            const aspectRatio = viewport.height / viewport.width;
            let totalHeight = 0;
            const containerWidth = scrollContainer.clientWidth;
            const pageRenderWidth = containerWidth * 0.95;

            for (let i = 1; i <= pdfDocument.numPages; i++) {
                const pageContainer = document.createElement('div');
                pageContainer.className = 'pdf-page-container';
                pageContainer.dataset.pageNumber = i;
                const pageHeight = pageRenderWidth * aspectRatio;
                pageContainer.style.height = `${pageHeight}px`;
                pdfWrapper.appendChild(pageContainer);
                totalHeight += pageHeight + 16;
            }

            startPageObserver();
            updatePageIndicator();
            setActiveTool('select');
        }

        // Observer de páginas
        function startPageObserver() {
            if (pageIntersectionObserver) {
                pageIntersectionObserver.disconnect();
            }

            pageIntersectionObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const pageNum = parseInt(entry.target.dataset.pageNumber);
                        if (!entry.target.querySelector('canvas')) {
                            renderPage(entry.target, pageNum);
                        }
                        if (Math.abs(pageNum - currentPageNum) >= 1) {
                            currentPageNum = pageNum;
                            updatePageIndicator();
                        }
                    }
                });
            }, {
                root: scrollContainer,
                rootMargin: '100px 0px',
                threshold: 0.1
            });

            document.querySelectorAll('.pdf-page-container').forEach(container => {
                pageIntersectionObserver.observe(container);
            });
        }

        // Renderizar página individual
        async function renderPage(pageContainer, pageNum) {
            if (!pdfDocument) return;

            try {
                const page = await pdfDocument.getPage(pageNum);
                const scale = 2.0;
                const viewport = page.getViewport({ scale });

                const canvas = document.createElement('canvas');
                const annotationCanvas = document.createElement('canvas');

                canvas.width = annotationCanvas.width = viewport.width;
                canvas.height = annotationCanvas.height = viewport.height;

                annotationCanvas.className = 'annotation-canvas';
                annotationCanvas.dataset.pageNum = pageNum;

                const context = canvas.getContext('2d');
                await page.render({ canvasContext: context, viewport }).promise;

                pageContainer.innerHTML = '';
                pageContainer.append(canvas, annotationCanvas);

                redrawAnnotations(pageNum);
                setupDrawingListeners(annotationCanvas);
            } catch (error) {
                console.error(`Error renderizando página ${pageNum}:`, error);
            }
        }

        // Configurar listeners de dibujo para un canvas
        function setupDrawingListeners(canvas) {
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing, { passive: false });

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
        }

        // Funciones de dibujo
        function startDrawing(e) {
            if (activeTool === 'select') return;

            isDrawing = true;
            currentPath = [];

            const coords = getCoords(e, e.target);
            currentPath.push(coords);
            e.preventDefault();
        }

        function draw(e) {
            if (!isDrawing) return;

            e.preventDefault();
            const coords = getCoords(e, e.target);
            currentPath.push(coords);

            // Dibujar en tiempo real
            const ctx = e.target.getContext('2d');
            ctx.strokeStyle = activeColor;
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';

            if (currentPath.length > 1) {
                const prevPoint = currentPath[currentPath.length - 2];
                ctx.beginPath();
                ctx.moveTo(prevPoint.x, prevPoint.y);
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
            }
        }

        function stopDrawing(e) {
            if (!isDrawing) return;

            isDrawing = false;

            if (currentPath.length > 1) {
                const pageNum = parseInt(e.target.dataset.pageNum);

                // Guardar anotación
                const annotationData = {
                    type: activeTool,
                    color: activeColor,
                    path: currentPath,
                    page: pageNum
                };

                saveAnnotation(annotationData).then(() => {
                    console.log('Anotación guardada');
                });
            }

            currentPath = [];
        }

        function getCoords(e, canvas) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            const touch = e.touches ? e.touches[0] : e;
            return {
                x: (touch.clientX - rect.left) * scaleX,
                y: (touch.clientY - rect.top) * scaleY
            };
        }

        // Redibujar anotaciones
        function redrawAnnotations(pageNum) {
            const pageAnnotations = annotationsByPage[pageNum] || [];
            const canvas = document.querySelector(`[data-page-number="${pageNum}"] .annotation-canvas`);

            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            pageAnnotations.forEach(annotation => {
                if (annotation.path && annotation.path.length > 0) {
                    drawPath(ctx, annotation);
                }
            });
        }

        function drawPath(ctx, annotation) {
            if (!annotation.path || annotation.path.length < 2) return;

            ctx.save();
            ctx.strokeStyle = annotation.color || '#FFDD00';
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.lineWidth = annotation.type === 'erase' ? 40 : 4;

            ctx.beginPath();
            ctx.moveTo(annotation.path[0].x, annotation.path[0].y);
            annotation.path.forEach(point => ctx.lineTo(point.x, point.y));

            if (annotation.type === 'erase') {
                ctx.globalCompositeOperation = 'destination-out';
            } else {
                ctx.globalCompositeOperation = 'source-over';
            }

            ctx.stroke();
            ctx.restore();
        }

        // Herramientas
        function setActiveTool(tool) {
            activeTool = tool;
            document.querySelectorAll('#main-tools .tool-btn').forEach(btn => 
                btn.classList.remove('active')
            );
            const toolBtn = document.getElementById(`tool-${tool}`);
            if (toolBtn) toolBtn.classList.add('active');
        }

        // Guardar anotación
        function saveAnnotation(annotationData) {
            return addDoc(collection(db, "users", currentUser.uid, "projects", projectId, "pdfs", pdfId, "annotations"), {
                ...annotationData,
                createdAt: serverTimestamp()
            });
        }

        // Cargar todas las anotaciones
        function loadAllAnnotations() {
            if (annotationsUnsubscribe) annotationsUnsubscribe();

            const annotationsQuery = query(
                collection(db, "users", currentUser.uid, "projects", projectId, "pdfs", pdfId, "annotations"),
                orderBy("createdAt")
            );

            annotationsUnsubscribe = onSnapshot(annotationsQuery, (snapshot) => {
                annotationsByPage = {};
                snapshot.docs.forEach(doc => {
                    const annotation = { id: doc.id, ...doc.data() };
                    if (!annotationsByPage[annotation.page]) {
                        annotationsByPage[annotation.page] = [];
                    }
                    annotationsByPage[annotation.page].push(annotation);
                });

                renderNotesToSidebar();

                document.querySelectorAll('.pdf-page-container').forEach(pageContainer => {
                    if (pageContainer.querySelector('canvas')) {
                        redrawAnnotations(pageContainer.dataset.pageNumber);
                    }
                });
            });
        }

        // Renderizar notas en sidebar
        function renderNotesToSidebar() {
            if (!notesList) return;

            notesList.innerHTML = '';

            const annotationsWithNotes = Object.values(annotationsByPage)
                .flat()
                .filter(a => a.id && a.note)
                .sort((a, b) => (a.page - b.page));

            if (annotationsWithNotes.length === 0) {
                notesList.innerHTML = `<p class="text-gray-500 text-center p-4">No hay notas guardadas.</p>`;
                return;
            }

            annotationsWithNotes.forEach(annotation => {
                const noteElement = document.createElement('div');
                noteElement.className = 'bg-gray-800 p-3 rounded-lg mb-2';
                noteElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs text-gray-400">Página ${annotation.page}</span>
                    </div>
                    <p class="text-sm text-white">${annotation.note}</p>
                `;
                notesList.appendChild(noteElement);
            });
        }

        // Actualizar indicador de página
        function updatePageIndicator() {
            const indicator = document.getElementById('page-indicator');
            if (indicator && pdfDocument) {
                indicator.textContent = `${currentPageNum} / ${pdfDocument.numPages}`;
            }
        }

        // Funciones de notas (simplificadas)
        async function handleAddNewNote() {
            const { value: noteText } = await Swal.fire({
                title: 'Nueva Nota',
                input: 'textarea',
                inputPlaceholder: 'Escribe tu nota aquí...',
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar'
            });

            if (noteText) {
                const annotationData = {
                    type: 'note',
                    note: noteText,
                    page: currentPageNum,
                    color: activeColor
                };
                await saveAnnotation(annotationData);
            }
        }

        async function handleClearNotes() {
            const result = await Swal.fire({
                title: '¿Borrar todas las notas?',
                text: 'Solo se borrarán las notas de texto, no los dibujos.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, borrar',
                cancelButtonText: 'Cancelar'
            });

            if (result.isConfirmed) {
                const batch = writeBatch(db);
                Object.values(annotationsByPage).flat()
                    .filter(a => a.note)
                    .forEach(a => {
                        const docRef = doc(db, "users", currentUser.uid, "projects", projectId, "pdfs", pdfId, "annotations", a.id);
                        batch.delete(docRef);
                    });
                await batch.commit();
            }
        }

        async function handleClearAll() {
            const result = await Swal.fire({
                title: '¿Borrar todo?',
                text: 'Se borrarán todas las anotaciones y dibujos.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, borrar todo',
                cancelButtonText: 'Cancelar'
            });

            if (result.isConfirmed) {
                const batch = writeBatch(db);
                Object.values(annotationsByPage).flat().forEach(a => {
                    const docRef = doc(db, "users", currentUser.uid, "projects", projectId, "pdfs", pdfId, "annotations", a.id);
                    batch.delete(docRef);
                });
                await batch.commit();
            }
        }

        console.log('✅ SISTEMA COMPLETAMENTE FUNCIONAL Y REPARADO');
    </script>
</body>
</html>