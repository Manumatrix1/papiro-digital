<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espacio de Trabajo</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <header class="header">
        <a href="panel.html" class="logo">PAPIRO</a>
        <nav class="navbar">
            <a href="mi_tablero.html">Mi Tablero</a>
            <a href="index.html" id="logout-button">Cerrar Sesión</a>
        </nav>
    </header>

    <div class="content-container">
        <div class="header-content">
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Buscar...">
                <button id="search-btn" class="icon-btn"><i class="fas fa-search"></i></button>
            </div>
            <h1 id="document-title">Cargando...</h1>
            <div class="header-buttons">
                <button class="action-btn" id="save-note-btn">Guardar Título</button>
                <button class="action-btn" id="delete-btn">Eliminar</button>
            </div>
        </div>
        
        <div class="pdf-viewer-container" id="pdf-viewer-container">
            </div>

        <div id="pdf-loading">
            <p>Cargando documento...</p>
            <div class="spinner"></div>
        </div>

        <div id="pdf-error" style="display:none;">
            <div class="error-icon">
                <i class="fas fa-times-circle"></i>
            </div>
            <h2>Error</h2>
            <p>No se pudo cargar el documento PDF. Intente de nuevo.</p>
            <button id="error-ok-button" class="action-btn">OK</button>
        </div>

        <button class="action-btn return-btn" id="return-btn">Volver al Tablero</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>
    <script src="firebase-config.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <script>
        const db = firebase.firestore();
        let authUser = null;

        // --- CÓDIGO CORREGIDO PARA LA AUTENTICACIÓN Y CARGA DEL PDF ---
        // Escuchamos el estado de autenticación para saber si hay un usuario logueado
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                authUser = user;
                console.log('Usuario autenticado:', user.uid);

                const urlParams = new URLSearchParams(window.location.search);
                const docId = urlParams.get('id');

                if (docId) {
                    // Si hay un usuario y un ID, cargamos el visor de PDF
                    loadPDFViewer(docId);
                }
            } else {
                authUser = null;
                console.log('Usuario no autenticado. Redirigiendo.');
                window.location.href = 'index.html';
            }
        });

        function loadPDFViewer(docId) {
            // Obtenemos la referencia al documento en Firestore para obtener el projectId
            db.collection("proyectos").where("pdfs", "array-contains", docId).get().then(querySnapshot => {
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    const projectId = doc.id;
                    
                    // Obtenemos la referencia al archivo PDF en Storage
                    const storageRef = firebase.storage().ref();
                    // La ruta debe coincidir con cómo guardas tus archivos en Storage.
                    // Si el nombre del archivo PDF no es docId.pdf, debes ajustarlo.
                    const pdfRef = storageRef.child(`proyectos/${projectId}/${docId}/pdfs/${docId}.pdf`); 

                    // Con la referencia, obtenemos la URL de descarga segura
                    pdfRef.getDownloadURL().then(url => {
                        const viewerContainer = document.getElementById('pdf-viewer-container');
                        viewerContainer.innerHTML = '';
                        const iframe = document.createElement('iframe');
                        iframe.src = `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(url)}`;
                        iframe.style.width = '100%';
                        iframe.style.height = '100%';
                        iframe.style.border = 'none';
                        viewerContainer.appendChild(iframe);
                        document.getElementById('pdf-loading').style.display = 'none';

                    }).catch(error => {
                        console.error('Error al obtener la URL de descarga:', error);
                        document.getElementById('pdf-loading').style.display = 'none';
                        document.getElementById('pdf-error').style.display = 'block';
                    });

                } else {
                    console.log("Documento no encontrado en Firestore.");
                    document.getElementById('pdf-loading').style.display = 'none';
                    document.getElementById('pdf-error').style.display = 'block';
                }
            }).catch(error => {
                console.error("Error buscando el documento:", error);
                document.getElementById('pdf-loading').style.display = 'none';
                document.getElementById('pdf-error').style.display = 'block';
            });
        }
        // --- FIN DEL CÓDIGO CORREGIDO ---

        document.getElementById('return-btn').addEventListener('click', () => {
            window.location.href = 'mi_tablero.html';
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            firebase.auth().signOut().then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Error al cerrar sesión:', error);
            });
        });

        document.getElementById('error-ok-button').addEventListener('click', () => {
            window.location.href = 'mi_tablero.html';
        });

    </script>
</body>
</html>
